# Story 3.1: Chatwoot Customer Service

## Status
Approved

## Story
**As a** customer service manager,
**I want** Chatwoot v4.6.0-ce deployed with database integration,
**so that** I can manage customer communications across multiple channels.

## Acceptance Criteria
1. Chatwoot container running with specified version
2. Database connection to PostgreSQL working
3. Redis connection for session management configured
4. WhatsApp channel integration via Evolution API and n8n
5. Agent user management system working
6. Basic customer conversation flow tested

## Tasks / Subtasks

- [ ] **Task 1: Add Chatwoot Service to docker-compose.yml** (AC: 1, 2, 3)
  - [ ] Add Chatwoot service definition using `chatwoot/chatwoot:v4.6.0-ce` image
  - [ ] Configure Chatwoot on both `borgstack_internal` and `borgstack_external` networks
  - [ ] Mount persistent volumes `borgstack_chatwoot_storage` and `borgstack_chatwoot_public`
  - [ ] Set database connection environment variables (DATABASE_URL, POSTGRES_*)
  - [ ] Set Redis connection environment variables (REDIS_URL)
  - [ ] Configure Rails environment variables (SECRET_KEY_BASE, RAILS_ENV=production)
  - [ ] Add restart policy: `unless-stopped`
  - [ ] Configure container name: `chatwoot`
  - [ ] Add dependency on `postgresql` (condition: service_healthy)
  - [ ] Add dependency on `redis` (condition: service_healthy)

- [ ] **Task 2: Configure Chatwoot Environment Variables** (AC: 1, 2, 3, 4)
  - [ ] Set DATABASE_URL to `postgresql://chatwoot_user:${CHATWOOT_DB_PASSWORD}@postgresql:5432/chatwoot_db`
  - [ ] Set REDIS_URL to `redis://:${REDIS_PASSWORD}@redis:6379`
  - [ ] Set SECRET_KEY_BASE from .env variable (Rails secret - 128-char hex string)
  - [ ] Set FRONTEND_URL to `https://${CHATWOOT_HOST}`
  - [ ] Set INSTALLATION_NAME to 'BorgStack Chatwoot'
  - [ ] Set FORCE_SSL to 'true' for production security
  - [ ] Set RAILS_ENV to 'production'
  - [ ] Set RAILS_LOG_TO_STDOUT to 'true' for Docker logs

- [ ] **Task 3: Implement Chatwoot Health Check** (AC: 1)
  - [ ] Add health check using `wget --no-verbose --tries=1 --spider http://localhost:3000/api || exit 1`
  - [ ] Set health check interval to 30 seconds
  - [ ] Set timeout to 10 seconds
  - [ ] Set retries to 5 before marking unhealthy
  - [ ] Set start_period to 90 seconds (Rails migrations + asset compilation)

- [ ] **Task 4: Update .env.example with Chatwoot Variables** (AC: 1, 2, 3, 4)
  - [ ] Add `CHATWOOT_HOST=chatwoot.${DOMAIN}` variable
  - [ ] Add `CHATWOOT_DB_PASSWORD=<generate-strong-password>` placeholder
  - [ ] Add `CHATWOOT_SECRET_KEY_BASE=<generate-secret-key>` placeholder
  - [ ] Add `CHATWOOT_API_TOKEN=<obtain-from-admin-ui-after-first-login>` placeholder
  - [ ] Add comment: "Chatwoot customer service platform credentials"
  - [ ] Add security warning about protecting secret key and API token
  - [ ] Add note: "CHATWOOT_API_TOKEN must be generated from Chatwoot admin UI after first login (Settings → Account Settings → Access Tokens)"

- [ ] **Task 5a: Verify Chatwoot Caddy Configuration** (AC: 1)
  - [ ] Verify reverse proxy block for `${CHATWOOT_HOST}` exists in Caddyfile
  - [ ] Verify proxy target is set to `http://chatwoot:3000`
  - [ ] Verify security headers are configured
  - [ ] Verify automatic HTTPS via Let's Encrypt is enabled
  - [ ] Confirm configuration matches Story 1.5 Caddy setup

- [ ] **Task 5b: Test Chatwoot Web UI via Caddy** (AC: 1)
  - [ ] Verify DNS A record for ${CHATWOOT_HOST} resolves to server IP: `dig ${CHATWOOT_HOST} +short`
  - [ ] Deploy Chatwoot service with `docker compose up -d chatwoot`
  - [ ] Wait for health check to pass (90s start_period)
  - [ ] Test Chatwoot web UI accessibility: `curl -f https://${CHATWOOT_HOST}/`
  - [ ] Verify HTTPS redirection working
  - [ ] Verify security headers in response

- [ ] **Task 6: Verify PostgreSQL Database Configuration** (AC: 2)
  - [ ] Verify chatwoot_db database creation in `config/postgresql/init-databases.sql` (already configured)
  - [ ] Verify chatwoot_user creation with password from `${CHATWOOT_DB_PASSWORD}` (already configured)
  - [ ] Verify ALL PRIVILEGES granted on chatwoot_db to chatwoot_user (already configured)
  - [ ] Verify chatwoot_user set as owner of chatwoot_db (already configured)

- [ ] **Task 7: Add Chatwoot Password Generation to Bootstrap Script** (AC: 2, 3)
  - [ ] Add CHATWOOT_DB_PASSWORD generation to `scripts/bootstrap.sh` using `openssl rand -base64 32 | tr -d "=+/" | cut -c1-32`
  - [ ] Add CHATWOOT_SECRET_KEY_BASE generation using `openssl rand -hex 64`
  - [ ] Ensure both secrets are written to .env file during bootstrap
  - [ ] Add Chatwoot credentials to credential summary display
  - [ ] Add completion message warning about manual CHATWOOT_API_TOKEN generation requirement:
    ```bash
    echo "⚠️  IMPORTANT: CHATWOOT_API_TOKEN requires manual generation:"
    echo "   1. Login to Chatwoot: https://chatwoot.${DOMAIN}/app"
    echo "   2. Go to Settings → Account Settings → Access Tokens"
    echo "   3. Create New Token and add to .env as CHATWOOT_API_TOKEN"
    echo "   4. Restart chatwoot: docker compose restart chatwoot"
    ```

- [ ] **Task 8: Create Chatwoot Setup Documentation** (AC: 4, 5, 6)
  - [ ] Create `config/chatwoot/README.md` with initial setup instructions
  - [ ] Document first-time admin account creation process
  - [ ] **Document API token generation (CRITICAL - Manual Step Required):**
    - Emphasize this CANNOT be automated via bootstrap script
    - Step-by-step: Login → Settings → Account Settings → Access Tokens → Create New Token
    - Document token permissions required for n8n integration (full access)
    - Add warning: Token must be added to .env before n8n workflows can access Chatwoot API
  - [ ] Document adding CHATWOOT_API_TOKEN to .env file for n8n integration
  - [ ] Document agent user management and permissions (AC5: Agent user management system)
  - [ ] Document WhatsApp channel integration via Evolution API + n8n (AC4: Primary messaging channel for MVP)
  - [ ] Document future social media channel integrations (Instagram DM, Facebook Messenger, Telegram) - marked as post-MVP
  - [ ] Add troubleshooting guide for common issues

- [ ] **Task 9: Create Chatwoot Validation Tests** (AC: 1, 2, 3, 5, 6)
  - [ ] Create `tests/deployment/verify-chatwoot.sh` test script
  - [ ] Test 1: Verify Chatwoot container is running
  - [ ] Test 2: Verify Chatwoot health check passes
  - [ ] Test 3: Verify Chatwoot database connection works (Rails migrations completed)
  - [ ] Test 4: Verify Chatwoot Redis connection works
  - [ ] Test 5: Verify Chatwoot web UI accessible via Caddy (HTTPS)
  - [ ] Test 6: Verify volumes `borgstack_chatwoot_storage` and `borgstack_chatwoot_public` are mounted
  - [ ] Test 7: Verify Chatwoot API health endpoint returns 200 OK
  - [ ] Test 8: Verify agent management API endpoint accessible (validates AC5)
    - If CHATWOOT_API_TOKEN set: `curl -f https://${CHATWOOT_HOST}/api/v1/accounts/{account_id}/agents -H "api_access_token: ${CHATWOOT_API_TOKEN}"`
    - If token not set: Skip test with warning message
  - [ ] Make script executable: `chmod +x tests/deployment/verify-chatwoot.sh`

- [ ] **Task 10: Add Chatwoot to CI Validation** (AC: 1, 2, 3)
  - [ ] Update `.github/workflows/ci.yml` to validate Chatwoot service
  - [ ] Add job to check Chatwoot image version in docker-compose.yml
  - [ ] Add job to validate Chatwoot environment variables are set
  - [ ] Verify Chatwoot volume naming follows `borgstack_` convention
  - [ ] Verify Chatwoot depends_on configuration includes PostgreSQL and Redis
  - [ ] Verify no port exposure to host (security requirement)

- [ ] **Task 11: Create n8n Integration Workflow for WhatsApp → Chatwoot** (AC: 4, 6)
  - [ ] **PREREQUISITE:** CHATWOOT_API_TOKEN must be generated from admin UI first (see Task 8)
  - [ ] Create n8n workflow example: `config/n8n/workflows/04-whatsapp-chatwoot-integration.json`
  - [ ] Document Evolution API webhook → n8n → Chatwoot API flow
  - [ ] Document Chatwoot API authentication with access token (uses CHATWOOT_API_TOKEN from .env)
  - [ ] Create workflow to create Chatwoot conversations from WhatsApp messages
  - [ ] Add example API payloads for conversation creation and message posting
  - [ ] Document error handling and retry logic
  - [ ] Add note: API token should be stored as n8n credential for secure access

- [ ] **Task 12: Update Documentation** (AC: 1, 4, 5, 6)
  - [ ] Update README.md with Chatwoot service information
  - [ ] Document Chatwoot admin access URL and first-time setup
  - [ ] Document agent management and conversation handling
  - [ ] Document channel integration procedures (email, SMS, WhatsApp)
  - [ ] Add troubleshooting section for Chatwoot issues

## Dev Notes

### Previous Story Insights

**From Story 2.2 (Evolution API Integration):**
- Evolution API v2.2.3 deployed with WhatsApp Business API connectivity
- Webhook integration pattern established: Evolution API → n8n → [Future: Chatwoot]
- n8n can receive WhatsApp messages via webhook and forward to Chatwoot API
- Health check pattern with 60-90s start_period for migrations validated
- Dual network pattern: `borgstack_internal` for DB/Redis, `borgstack_external` for Caddy

**From Story 2.1 (n8n Workflow Platform):**
- n8n 1.112.6 deployed and ready for workflow orchestration
- Webhook pattern validated for service integration
- HTTP Request nodes available for calling external APIs (Chatwoot API)

**From Story 1.5 (Caddy Reverse Proxy):**
- Caddy 2.10-alpine configured with automatic HTTPS
- Reverse proxy block for Chatwoot already exists in Caddyfile: `chatwoot.{$DOMAIN} → http://chatwoot:3000`
- Security headers configured (X-Frame-Options, X-Content-Type-Options, Referrer-Policy)

**From Story 1.6 (Bootstrap Script):**
- Bootstrap script generates strong passwords: `openssl rand -base64 32`
- Rails secret key generation: `openssl rand -hex 64` (128-character hex string)
- .env file created with 600 permissions (secure)

**From Story 1.3 (PostgreSQL Database Setup):**
- PostgreSQL 18.0 with pgvector extension configured
- Database initialization script: `config/postgresql/init-databases.sql`
- Chatwoot database (chatwoot_db) already created with chatwoot_user
- Connection format: `postgresql://chatwoot_user:${CHATWOOT_DB_PASSWORD}@postgresql:5432/chatwoot_db`

**From Story 1.4 (Redis Cache Configuration):**
- Redis 8.2-alpine configured at `redis:6379`
- Password-protected with `${REDIS_PASSWORD}` from .env
- Connection format: `redis://:${REDIS_PASSWORD}@redis:6379`

**Key Integration Points:**
- Chatwoot requires TWO secrets: CHATWOOT_DB_PASSWORD (database) and CHATWOOT_SECRET_KEY_BASE (Rails session encryption)
- Chatwoot database already configured in PostgreSQL init script (chatwoot_db + chatwoot_user)
- Chatwoot reverse proxy block already configured in Caddy
- WhatsApp integration flow: WhatsApp → Evolution API → n8n → Chatwoot API (to be implemented in Task 11)

### Chatwoot Component Specifications

**Chatwoot (Customer Service Platform)** [Source: architecture/components.md#chatwoot]

**Responsibility:** Omnichannel customer communication platform with agent management and conversation tracking.

**Key Interfaces:**
- Web UI (port 3000) exposed via Caddy
- REST API for conversation management at `/api/v1/*`
- Webhook configuration for Evolution API integration
- Agent dashboard and customer-facing widget

**Dependencies:**
- PostgreSQL (`chatwoot_db`)
- Redis (Sidekiq background jobs for async processing)
- Evolution API (WhatsApp channel integration via n8n)

**Storage Strategy (MVP):**
- **Story 3.1 (this story):** Uses LOCAL VOLUMES (`borgstack_chatwoot_storage`, `borgstack_chatwoot_public`)
- **SeaweedFS Integration:** DEFERRED to Epic 5 (Story 5.3: Storage Integration Testing)
- **Rationale:** Local volumes sufficient for MVP; S3-compatible storage is enhancement

**Technology Stack:**
- Image: `chatwoot/chatwoot:v4.6.0-ce`
- Volumes: `borgstack_chatwoot_storage` (file uploads), `borgstack_chatwoot_public` (Rails public assets)
- Services: Web server (Puma), Background worker (Sidekiq), Rails console
- Framework: Ruby on Rails with ActiveRecord migrations

### Database Configuration

**PostgreSQL Database for Chatwoot** [Source: architecture/database-schema.md#postgresql-database-organization]

**Server:** PostgreSQL 18.0 with pgvector extension
**Image:** `pgvector/pgvector:pg18`
**Host:** `postgresql:5432` on `borgstack_internal` network

**Database Initialization Script (config/postgresql/init-databases.sql):**
```sql
-- Chatwoot Database Configuration
CREATE DATABASE chatwoot_db;
CREATE USER chatwoot_user WITH ENCRYPTED PASSWORD '${CHATWOOT_DB_PASSWORD}';
GRANT ALL PRIVILEGES ON DATABASE chatwoot_db TO chatwoot_user;
ALTER DATABASE chatwoot_db OWNER TO chatwoot_user;
```

**Schema Management:**
Chatwoot manages its PostgreSQL schema automatically using Rails ActiveRecord migrations on first startup. Migrations run during container startup before the web server starts.

**Connection String Format:**
```
DATABASE_URL=postgresql://chatwoot_user:${CHATWOOT_DB_PASSWORD}@postgresql:5432/chatwoot_db
```

**Note:** Chatwoot v4.6.0-ce supports modern `DATABASE_URL` format (single source of truth). Individual `POSTGRES_*` variables are not required.

### Redis Configuration

**Redis Connection for Chatwoot** [Source: architecture/database-schema.md#redis-data-organization]

**Server:** Redis 8.2-alpine
**Host:** `redis:6379` on `borgstack_internal` network

**Key Namespace Strategy:**
```
chatwoot:sidekiq:{queue}          # Chatwoot background jobs (Sidekiq)
chatwoot:cache:{key}              # Chatwoot application cache
chatwoot:session:{userId}         # Chatwoot user sessions
```

**Connection Format:**
```
REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
```

**Sidekiq Background Jobs:**
Chatwoot uses Sidekiq for background processing (email sending, notifications, conversation assignments). The same Redis instance is shared for both cache and job queue.

### Docker Compose Configuration

**Service Definition Template:**
```yaml
services:
  chatwoot:
    image: chatwoot/chatwoot:v4.6.0-ce
    container_name: chatwoot
    restart: unless-stopped
    networks:
      - borgstack_internal
      - borgstack_external
    environment:
      # PostgreSQL connection (single source of truth)
      DATABASE_URL: postgresql://chatwoot_user:${CHATWOOT_DB_PASSWORD}@postgresql:5432/chatwoot_db

      # Redis connection
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379

      # Rails configuration
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      FORCE_SSL: "true"

      # Chatwoot configuration
      FRONTEND_URL: https://${CHATWOOT_HOST}
      INSTALLATION_NAME: BorgStack Chatwoot

    volumes:
      - borgstack_chatwoot_storage:/app/storage
      - borgstack_chatwoot_public:/app/public
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
      # Rationale for 90s start_period:
      #   - Rails database migrations: ~30-45s (ActiveRecord schema creation)
      #   - Webpacker asset compilation: ~20-30s (JavaScript/CSS bundles)
      #   - Sidekiq worker initialization: ~10s (background job processor)
      #   - Puma web server startup: ~5s (Rails application server)
      # Total: ~65-90s (90s provides safety margin for slower systems)

volumes:
  borgstack_chatwoot_storage:
    driver: local
  borgstack_chatwoot_public:
    driver: local
```

**Critical Configuration Notes:**
- Chatwoot needs TWO networks: `borgstack_internal` (DB/Redis) and `borgstack_external` (Caddy proxy) [Source: architecture/coding-standards.md#network-isolation]
- Volume names use `borgstack_` prefix per coding standards [Source: architecture/coding-standards.md#volume-naming-convention]
- Restart policy `unless-stopped` for automatic recovery [Source: architecture/coding-standards.md#critical-infrastructure-rules]
- Health check tests `/api` endpoint (Chatwoot API health check)
- Depends on PostgreSQL and Redis with `service_healthy` condition
- Rails migrations run automatically on first startup
- Health check `start_period: 90s` accommodates Rails migrations (30-45s), asset compilation (20-30s), Sidekiq init (10s), and Puma startup (5s)
- SECRET_KEY_BASE must be 128+ character hex string for Rails session encryption

### Caddy Reverse Proxy Configuration

**Caddyfile Block for Chatwoot** [Source: architecture/components.md#caddy]

**Already configured in config/caddy/Caddyfile:**
```
# Chatwoot - Customer Service Platform
chatwoot.{$DOMAIN} {
    reverse_proxy chatwoot:3000

    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Automatic HTTPS via Let's Encrypt
    tls {$CADDY_EMAIL}
}
```

**API Access URLs:**
- Admin Dashboard: `https://chatwoot.${DOMAIN}/app`
- API Base URL: `https://chatwoot.${DOMAIN}/api/v1`
- Health Check: `https://chatwoot.${DOMAIN}/api` (returns 200 OK when healthy)
- Public Widget: `https://chatwoot.${DOMAIN}/packs/js/sdk.js`

### Coding Standards Compliance

**Volume Naming Convention** [Source: architecture/coding-standards.md]
- Volumes must be named: `borgstack_chatwoot_storage`, `borgstack_chatwoot_public`
- Prefix `borgstack_` required to prevent conflicts with other Docker stacks
- Volume type: Named volumes with local driver

**Network Configuration** [Source: architecture/coding-standards.md]
- Chatwoot must be on BOTH networks:
  - `borgstack_internal`: For database and Redis access
  - `borgstack_external`: For Caddy reverse proxy access
- Rationale: Chatwoot needs DB/Redis internally + external HTTPS access via Caddy

**Health Check Requirements** [Source: architecture/coding-standards.md]
- All long-running services must define health checks
- Chatwoot health check: `wget --no-verbose --tries=1 --spider http://localhost:3000/api || exit 1`
- Enables proper startup ordering with `depends_on: { condition: service_healthy }`

**Dependency Management** [Source: architecture/coding-standards.md]
- Chatwoot depends on PostgreSQL (must be healthy before Chatwoot starts)
- Chatwoot depends on Redis (must be healthy before Chatwoot starts)
- Use `depends_on` with `condition: service_healthy` for proper sequencing

**Environment Variable Security** [Source: architecture/coding-standards.md]
- Never commit `.env` files or secrets to git
- Use `.env.example` as template with placeholder values
- `.gitignore` must exclude `.env` files (already configured in Story 1.1)

### File Locations

**New Files to Create:**
- `config/chatwoot/README.md` - Chatwoot setup and integration guide
- `config/n8n/workflows/04-whatsapp-chatwoot-integration.json` - n8n workflow for WhatsApp → Chatwoot integration
- `tests/deployment/verify-chatwoot.sh` - Chatwoot validation tests

**Files to Modify:**
- `docker-compose.yml` - Add Chatwoot service definition
- `.env.example` - Add CHATWOOT_* variables
- `scripts/bootstrap.sh` - Add Chatwoot password and secret key generation
- `.github/workflows/ci.yml` - Add Chatwoot validation jobs
- `README.md` - Document Chatwoot service
- `config/n8n/workflows/README.md` - Document WhatsApp → Chatwoot workflow

**Already Configured (Verify Only):**
- `config/postgresql/init-databases.sql` - chatwoot_db and chatwoot_user already configured (Story 1.3)
- `config/caddy/Caddyfile` - Chatwoot reverse proxy block already configured (Story 1.5)

**File Path Standards** [Source: architecture/unified-project-structure.md]
- Configuration files: `config/<service>/` directory
- Test scripts: `tests/deployment/` and `tests/integration/`
- Scripts: `scripts/` directory with kebab-case naming

### Tech Stack Context

**Chatwoot Version Selection** [Source: architecture/tech-stack.md]
- Version: Chatwoot v4.6.0-ce (`chatwoot/chatwoot:v4.6.0-ce` Docker image)
- Rationale: Open source alternative to Intercom/Zendesk; integrates with Evolution API for WhatsApp
- Image source: Official Chatwoot Docker Hub repository
- Backend: Ruby on Rails + Sidekiq (internal to container)
- License: MIT (Community Edition)

**Related Infrastructure** [Source: architecture/tech-stack.md]
- Docker Compose v2 for orchestration
- Docker volumes for persistent storage (uploaded files, Rails assets)
- Docker networks for service isolation (`borgstack_internal`, `borgstack_external`)

### Security Requirements

**Chatwoot Security Configuration** [Source: architecture/coding-standards.md, architecture/tech-stack.md]

1. **Rails Secret Key:**
   - SECRET_KEY_BASE must be 128-character hex string
   - Generated via: `openssl rand -hex 64`
   - Used for session encryption, cookie signing, Rails credentials
   - Strong secret key prevents session hijacking

2. **Database Security:**
   - Dedicated database user (chatwoot_user) with access ONLY to chatwoot_db
   - Strong password (32-character alphanumeric)
   - PostgreSQL connection over internal Docker network (no host exposure)

3. **Network Isolation:**
   - Database and Redis accessible only on `borgstack_internal` network
   - Admin UI exposed via Caddy on `borgstack_external` with HTTPS
   - API endpoints protected by HTTPS (automatic Let's Encrypt SSL)

4. **Credential Management:**
   - Passwords stored in .env file with 600 permissions
   - Strong password generation: 32-character alphanumeric via `openssl rand -base64 32`
   - Never commit .env to version control (enforced by .gitignore)

5. **HTTPS Enforcement:**
   - FORCE_SSL=true in Rails configuration
   - All HTTP requests redirected to HTTPS by Caddy
   - Let's Encrypt automatic certificate renewal

### Chatwoot API Specifications

**Chatwoot REST API for n8n Integration** [Source: Chatwoot API Documentation]

**Base URL:** `https://chatwoot.${DOMAIN}/api/v1`

**Authentication:**
```
Headers:
  api_access_token: {CHATWOOT_API_TOKEN}
```

**Key Endpoints for n8n Integration:**

**1. Create Contact (for new WhatsApp users):**
```
POST /api/v1/accounts/{account_id}/contacts
Content-Type: application/json
api_access_token: {CHATWOOT_API_TOKEN}

{
  "name": "João Silva",
  "phone_number": "+5511987654321",
  "identifier": "5511987654321@s.whatsapp.net"
}
```

**2. Create Conversation (for incoming WhatsApp messages):**
```
POST /api/v1/accounts/{account_id}/conversations
Content-Type: application/json
api_access_token: {CHATWOOT_API_TOKEN}

{
  "source_id": "5511987654321@s.whatsapp.net",
  "inbox_id": {inbox_id},
  "contact_id": {contact_id},
  "status": "open"
}
```

**3. Create Message (post WhatsApp message to conversation):**
```
POST /api/v1/accounts/{account_id}/conversations/{conversation_id}/messages
Content-Type: application/json
api_access_token: {CHATWOOT_API_TOKEN}

{
  "content": "Olá, preciso de ajuda com meu pedido #12345",
  "message_type": "incoming",
  "private": false
}
```

**4. Send Reply (agent response back to WhatsApp):**
```
POST /api/v1/accounts/{account_id}/conversations/{conversation_id}/messages
Content-Type: application/json
api_access_token: {CHATWOOT_API_TOKEN}

{
  "content": "Olá! Recebemos sua mensagem e estamos verificando seu pedido.",
  "message_type": "outgoing",
  "private": false
}
```

**Note:** Sending outgoing messages from Chatwoot requires n8n webhook listener to forward replies to Evolution API for WhatsApp delivery.

### Integration with n8n and Evolution API

**WhatsApp → Chatwoot Integration Flow** [Source: architecture/components.md#chatwoot]

**Data Flow:**
1. WhatsApp Phone → Evolution API (receives message)
2. Evolution API → n8n webhook (POST message event)
3. n8n → Chatwoot API (create/update contact, conversation, message)
4. Agent replies in Chatwoot UI
5. Chatwoot webhook → n8n (outgoing message event)
6. n8n → Evolution API (send WhatsApp message)
7. Evolution API → WhatsApp Phone (deliver message)

**n8n Workflow Structure (config/n8n/workflows/04-whatsapp-chatwoot-integration.json):**

```json
{
  "name": "04 - WhatsApp Chatwoot Integration",
  "nodes": [
    {
      "name": "Evolution Webhook",
      "type": "n8n-nodes-base.webhook",
      "parameters": {
        "path": "whatsapp-incoming",
        "httpMethod": "POST"
      }
    },
    {
      "name": "Extract WhatsApp Data",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "// Extract phone, message, sender name"
      }
    },
    {
      "name": "Find or Create Contact",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "https://chatwoot.${DOMAIN}/api/v1/accounts/{account_id}/contacts",
        "method": "POST",
        "authentication": "headerAuth"
      }
    },
    {
      "name": "Create Conversation",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "https://chatwoot.${DOMAIN}/api/v1/accounts/{account_id}/conversations",
        "method": "POST"
      }
    },
    {
      "name": "Post Message to Chatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "https://chatwoot.${DOMAIN}/api/v1/accounts/{account_id}/conversations/{conversation_id}/messages",
        "method": "POST"
      }
    }
  ]
}
```

### Testing

**Testing Strategy** [Source: architecture/testing-strategy.md]

**Testing Philosophy:**
- No unit tests (Chatwoot is pre-built Docker image)
- Focus: Configuration verification and deployment validation
- Verify Chatwoot container runs, health checks pass, and integrations work

**Required Validation Tests (create in `tests/deployment/verify-chatwoot.sh`):**

1. **Test 1: Container Running**
   - Command: `docker compose ps chatwoot | grep -q "Up"`
   - Expected: Chatwoot container in "Up" state

2. **Test 2: Health Check Passing**
   - Command: `docker compose ps chatwoot | grep -q "healthy"`
   - Expected: Container marked as healthy within 90 seconds

3. **Test 3: Database Connection**
   - Command: `docker compose logs chatwoot | grep -q "Rails migrations completed"`
   - Expected: Rails migrations successful

4. **Test 4: Redis Connection**
   - Command: `docker compose logs chatwoot | grep -q "Sidekiq"`
   - Expected: Sidekiq background worker started

5. **Test 5: Web UI Accessible via HTTPS**
   - Command: `curl -f -k https://${CHATWOOT_HOST}/ | grep -q "Chatwoot"`
   - Expected: Chatwoot web UI responds with HTTP 200

6. **Test 6: API Health Endpoint**
   - Command: `curl -f https://${CHATWOOT_HOST}/api`
   - Expected: API health check returns 200 OK

7. **Test 7: Volume Persistence**
   - Command: `docker volume ls | grep -q borgstack_chatwoot_storage && docker volume ls | grep -q borgstack_chatwoot_public`
   - Expected: Both volumes exist

**Integration with CI:**
- Add Chatwoot validation job to `.github/workflows/ci.yml`
- Run `docker compose config` to validate Chatwoot service syntax
- Validate Chatwoot environment variables are properly configured
- Verify volume naming convention (`borgstack_` prefix)

**Success Criteria:**
- All 7 validation tests pass
- Chatwoot accessible via HTTPS with admin dashboard
- Database and Redis connections working
- Persistent volumes mounted and data survives container restart
- Health check reports healthy status within 90 seconds of startup
- API endpoints functional

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation with comprehensive architecture context | Bob (Scrum Master) |
| 2025-10-03 | 1.1 | PO validation and corrections applied - Status: Approved | Sarah (PO Agent) |
| 2025-10-03 | 1.2 | SHOULD-FIX corrections applied after validation review | Sarah (PO Agent) |
| 2025-10-03 | 1.3 | Scope clarification: Removed email/SMS, focused on instant messaging only (WhatsApp MVP, social media post-MVP) | Sarah (PO Agent) |

**Version 1.3 Changes (Scope Clarification):**
- **AC4:** Changed from "Email and SMS channel integration setup" to "WhatsApp channel integration via Evolution API and n8n"
- **Task 8:** Removed email (SMTP) and SMS (Twilio) documentation subtasks
- **Task 8:** Added WhatsApp integration documentation (AC4 primary channel for MVP)
- **Task 8:** Added future social media integrations documentation (Instagram DM, Facebook Messenger, Telegram) - marked as post-MVP
- **Docker Compose Template:** Removed commented SMTP environment variables block (not in scope)
- **Rationale:** Chatwoot scope limited to instant messaging channels only; email handled by external provider

**Version 1.1 Changes (PO Validation):**
- **SHOULD-001:** Removed redundant POSTGRES_* environment variables; simplified to use only DATABASE_URL (single source of truth)
- **SHOULD-002:** Added CHATWOOT_API_TOKEN to Task 4 (.env.example), Task 8 (API token generation docs), and Task 11 (n8n integration prerequisite)
- **SHOULD-003:** Clarified SeaweedFS scope - Story 3.1 uses local volumes (MVP), SeaweedFS integration deferred to Epic 5
- **NICE-001:** Added DNS A record verification prerequisite to Task 5b (prevents Let's Encrypt failures)
- **NICE-002:** Expanded health check start_period rationale with timing breakdown (Rails migrations 30-45s, asset compilation 20-30s, Sidekiq 10s, Puma 5s)
- **Quality Score:** 9.0/10 (EXCELLENT) | Gate: CONDITIONAL GO → APPROVED | Confidence: HIGH (90%)

**Version 1.2 Changes (SHOULD-FIX Corrections):**
- **SHOULD-001:** Added Test 8 to Task 9 for agent management API validation (AC5 coverage improvement)
- **SHOULD-003:** Added manual CHATWOOT_API_TOKEN warning to Task 7 bootstrap script completion message
- **SHOULD-003:** Enhanced Task 8 API token documentation with CRITICAL manual step emphasis and detailed permissions
- **Note:** SHOULD-002 (E2E conversation flow testing) deferred to Story 6.1 (Integration Testing Suite) as planned
