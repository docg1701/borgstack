# Story 2.2: Evolution API Integration

## Status
Approved

## Story
**As a** communication specialist,
**I want** Evolution API v2.2.3 deployed with WhatsApp connectivity,
**so that** workflows can send and receive WhatsApp messages.

## Acceptance Criteria
1. Evolution API container running with specified version
2. WhatsApp Business API connection configured
3. Multi-instance support for different businesses
4. Database connection for message storage
5. Webhook endpoints for message events
6. Basic message sending/receiving functionality tested
7. Integration with n8n documented via HTTP/webhook patterns

## Tasks / Subtasks

- [ ] **Task 1: Add Evolution API Service to docker-compose.yml** (AC: 1, 4, 5)
  - [ ] Add Evolution API service definition using `atendai/evolution-api:v2.2.3` image
  - [ ] Configure Evolution API on both `borgstack_internal` and `borgstack_external` networks
  - [ ] Mount persistent volume `borgstack_evolution_instances` to `/evolution/instances`
  - [ ] Set database connection environment variables (DATABASE_URL, DATABASE_CONNECTION_*)
  - [ ] Set Redis connection environment variables (REDIS_*)
  - [ ] Set webhook URLs pointing to n8n endpoints
  - [ ] Add restart policy: `unless-stopped`
  - [ ] Configure container name: `evolution`
  - [ ] Add dependency on `postgresql` (condition: service_healthy)
  - [ ] Add dependency on `redis` (condition: service_healthy)

- [ ] **Task 2: Configure Evolution API Environment Variables** (AC: 2, 3, 5)
  - [ ] Set DATABASE_URL to PostgreSQL connection string for evolution_db
  - [ ] Set DATABASE_CONNECTION_URI for Prisma ORM
  - [ ] Set REDIS_URI to Redis connection string with password
  - [ ] Set SERVER_URL to `https://${EVOLUTION_HOST}` for webhook callbacks
  - [ ] Set WEBHOOK_GLOBAL_URL to n8n webhook endpoint
  - [ ] Set AUTHENTICATION_API_KEY from .env variable for API security
  - [ ] Set AUTHENTICATION_INSTANCE_ENABLED to enable instance-level auth
  - [ ] Set CONFIG_SESSION_PHONE_CLIENT to 'BorgStack WhatsApp Gateway'
  - [ ] Set QRCODE_COLOR for QR code generation customization
  - [ ] Configure multi-instance support (DATABASE_SAVE_DATA_INSTANCE=true)

- [ ] **Task 3: Implement Evolution API Health Check** (AC: 1)
  - [ ] Add health check using `wget --quiet --tries=1 --spider http://localhost:8080/ || exit 1` (tests root endpoint - Evolution API v2.2.3 has no documented /health endpoint)
  - [ ] Set health check interval to 30 seconds
  - [ ] Set timeout to 10 seconds
  - [ ] Set retries to 5 before marking unhealthy
  - [ ] Set start_period to 60 seconds for Prisma migrations

- [ ] **Task 4: Update .env.example with Evolution API Variables** (AC: 2, 5)
  - [ ] Add `EVOLUTION_HOST=evolution.${DOMAIN}` variable
  - [ ] Add `EVOLUTION_API_KEY=<generate-strong-key>` placeholder
  - [ ] Add `EVOLUTION_DB_PASSWORD=<generate-strong-password>` placeholder
  - [ ] Add `EVOLUTION_WEBHOOK_URL=https://${N8N_HOST}/webhook/whatsapp-incoming` variable
  - [ ] Add `DATABASE_CONNECTION_CLIENT_NAME=evolution_api` (Prisma client identifier)
  - [ ] Add comment: "Evolution API WhatsApp Business gateway credentials"
  - [ ] Add security warning about protecting API key

- [ ] **Task 5a: Verify Evolution API Caddy Configuration** (AC: 1)
  - [ ] Verify reverse proxy block for `${EVOLUTION_HOST}` exists in Caddyfile
  - [ ] Verify proxy target is set to `http://evolution:8080`
  - [ ] Verify security headers are configured (X-Frame-Options, X-Content-Type-Options, Referrer-Policy)
  - [ ] Verify automatic HTTPS via Let's Encrypt is enabled
  - [ ] Confirm configuration matches Story 1.5 Caddy setup

- [ ] **Task 5b: Test Evolution API Admin UI via Caddy** (AC: 1)
  - [ ] Deploy Evolution API service with `docker compose up -d evolution`
  - [ ] Wait for health check to pass (60s start_period)
  - [ ] Test Evolution API admin UI accessibility: `curl -f https://${EVOLUTION_HOST}/manager`
  - [ ] Verify HTTPS redirection working
  - [ ] Verify security headers in response

- [ ] **Task 6: Verify PostgreSQL Initialization Script** (AC: 4)
  - [ ] Verify evolution_db database creation in `config/postgresql/init-databases.sql` (already configured)
  - [ ] Verify evolution_user creation with password from `${EVOLUTION_DB_PASSWORD}` (already configured)
  - [ ] Verify ALL PRIVILEGES granted on evolution_db to evolution_user (already configured)
  - [ ] Verify evolution_user set as owner of evolution_db (already configured)

- [ ] **Task 7: Add Evolution API Password Generation to Bootstrap Script** (AC: 2, 5)
  - [ ] Add EVOLUTION_API_KEY generation to `scripts/bootstrap.sh` using `openssl rand -base64 32`
  - [ ] Add EVOLUTION_DB_PASSWORD generation using `openssl rand -base64 32 | tr -d "=+/" | cut -c1-32`
  - [ ] Ensure both passwords are written to .env file during bootstrap
  - [ ] Add Evolution API credentials to credential summary display

- [ ] **Task 8: Create WhatsApp Instance Setup Documentation** (AC: 2, 3, 6)
  - [ ] Create `config/evolution/README.md` with instance creation instructions
  - [ ] Document WhatsApp QR code connection procedure
  - [ ] Document multi-instance configuration (separate business accounts)
  - [ ] Document webhook configuration for n8n integration
  - [ ] Add troubleshooting guide for WhatsApp connection issues
  - [ ] Document message sending/receiving test procedures

- [ ] **Task 9: Create Evolution API Validation Tests** (AC: 1, 4, 5, 6)
  - [ ] Create `tests/deployment/verify-evolution.sh` test script
  - [ ] Test 1: Verify Evolution API container is running (`docker compose ps evolution`)
  - [ ] Test 2: Verify Evolution API health check passes
  - [ ] Test 3: Verify Evolution API database connection works
  - [ ] Test 4: Verify Evolution API Redis connection works
  - [ ] Test 5: Verify Evolution API web UI accessible via Caddy (HTTPS)
  - [ ] Test 6: Verify API authentication with EVOLUTION_API_KEY
  - [ ] Test 7: Verify volume `borgstack_evolution_instances` is mounted
  - [ ] Test 8: Verify instance creation API endpoint works
  - [ ] Make script executable: `chmod +x tests/deployment/verify-evolution.sh`

- [ ] **Task 10: Add Evolution API to CI Validation**
  - [ ] Update `.github/workflows/ci.yml` to validate Evolution API service
  - [ ] Add job to check Evolution API image version in docker-compose.yml
  - [ ] Add job to validate Evolution API environment variables are set
  - [ ] Verify Evolution API volume naming follows `borgstack_` convention
  - [ ] Verify Evolution API depends_on configuration includes PostgreSQL and Redis

- [ ] **Task 11: Create n8n Integration Documentation** (AC: 7)
  - [ ] Create n8n workflow example: `config/n8n/workflows/03-whatsapp-evolution-incoming.json`
  - [ ] Document Evolution API webhook configuration in n8n
  - [ ] Document Evolution API HTTP node configuration for sending messages
  - [ ] Create integration architecture diagram (Evolution → n8n → Chatwoot flow)
  - [ ] Add example message payloads (incoming/outgoing) to README.md
  - [ ] Document error handling and retry logic for WhatsApp messages

- [ ] **Task 12: Update Documentation**
  - [ ] Update README.md with Evolution API service information
  - [ ] Document Evolution API admin access URL and credentials
  - [ ] Document WhatsApp instance creation and QR code connection
  - [ ] Document Evolution API + n8n integration patterns
  - [ ] Add troubleshooting section for Evolution API issues

## Dev Notes

### Previous Story Insights

**From Story 2.1 (n8n Workflow Platform):**
- n8n 1.112.6 deployed with PostgreSQL and Redis integration
- Health check pattern established: `/healthz` endpoint with 60s start_period
- Dual network pattern validated (borgstack_internal for DB/Redis, borgstack_external for Caddy)
- Password generation pattern: `openssl rand -base64 32 | tr -d "=+/" | cut -c1-32`
- Webhook pattern ready: n8n can receive webhooks from Evolution API
- Example workflows available in `config/n8n/workflows/`

**From Story 1.5 (Caddy Reverse Proxy):**
- Caddy 2.10-alpine configured with automatic HTTPS
- Reverse proxy blocks in `config/caddy/Caddyfile`
- Security headers: X-Frame-Options, X-Content-Type-Options, Referrer-Policy
- HTTP to HTTPS redirection automatic

**From Story 1.6 (Bootstrap Script):**
- Bootstrap script generates strong passwords: `openssl rand -base64 32`
- .env file created with 600 permissions (secure)
- Health checks validated after service startup

**From Story 1.3 (PostgreSQL Database Setup):**
- PostgreSQL 18.0 with pgvector extension configured
- Database initialization script: `config/postgresql/init-databases.sql`
- Evolution API database (evolution_db) already created with evolution_user
- Connection format: `postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@postgresql:5432/evolution_db`

**From Story 1.4 (Redis Cache Configuration):**
- Redis 8.2-alpine configured at `redis:6379`
- Password-protected with `${REDIS_PASSWORD}` from .env
- Connection format: `redis://:${REDIS_PASSWORD}@redis:6379`

**Key Integration Points:**
- Evolution API requires TWO passwords: EVOLUTION_API_KEY (API auth), EVOLUTION_DB_PASSWORD (database)
- Evolution API already configured in PostgreSQL init script (evolution_db + evolution_user)
- Evolution API already has Caddy reverse proxy block configured
- n8n webhooks ready to receive Evolution API message events
- Evolution API will send webhooks to n8n at `https://${N8N_HOST}/webhook/whatsapp-incoming`

### Evolution API Component Specifications

**Evolution API (WhatsApp Integration)** [Source: architecture/components.md#evolution-api-whatsapp-integration]

**Responsibility:** Multi-instance WhatsApp Business API gateway for sending/receiving messages and managing connections.

**Key Interfaces:**
- REST API (port 8080) on `borgstack_internal` network
- Webhook delivery to n8n for incoming messages
- Instance management API
- QR code generation for WhatsApp connection

**Dependencies:**
- PostgreSQL (`evolution_db`)
- Redis (session management)
- n8n (webhook destination for message events)

**Technology Stack:**
- Image: `atendai/evolution-api:v2.2.3`
- Volume: `borgstack_evolution_instances` for WhatsApp session data
- Environment: Database connection, Redis, webhook URLs to n8n

### Database Configuration

**PostgreSQL Database for Evolution API** [Source: architecture/database-schema.md#postgresql-database-organization]

**Server:** PostgreSQL 18.0 with pgvector extension
**Image:** `pgvector/pgvector:pg18`
**Host:** `postgresql:5432` on `borgstack_internal` network

**Database Initialization Script (config/postgresql/init-databases.sql):**
```sql
-- Evolution API Database Configuration
CREATE DATABASE evolution_db;
CREATE USER evolution_user WITH ENCRYPTED PASSWORD '${EVOLUTION_DB_PASSWORD}';
GRANT ALL PRIVILEGES ON DATABASE evolution_db TO evolution_user;
ALTER DATABASE evolution_db OWNER TO evolution_user;
```

**Schema Management:**
Evolution API manages its PostgreSQL schema automatically using Prisma ORM migrations on first startup.

**Connection String Formats:**
```
DATABASE_URL=postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@postgresql:5432/evolution_db
DATABASE_CONNECTION_URI=postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@postgresql:5432/evolution_db
```

### Redis Configuration

**Redis Connection for Evolution API** [Source: architecture/database-schema.md#redis-data-organization]

**Server:** Redis 8.2-alpine
**Host:** `redis:6379` on `borgstack_internal` network

**Key Namespace Strategy:**
```
evolution:session:{instanceName}       # WhatsApp session data
evolution:cache:{instanceId}           # Instance configuration cache
evolution:queue:{queueName}            # Message queue
```

**Connection Format:**
```
REDIS_URI=redis://:${REDIS_PASSWORD}@redis:6379
```

### Docker Compose Configuration

**Service Definition Template:**
```yaml
services:
  evolution:
    image: atendai/evolution-api:v2.2.3
    container_name: evolution
    restart: unless-stopped
    networks:
      - borgstack_internal
      - borgstack_external
    environment:
      # Database connection
      DATABASE_URL: postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@postgresql:5432/evolution_db
      DATABASE_CONNECTION_URI: postgresql://evolution_user:${EVOLUTION_DB_PASSWORD}@postgresql:5432/evolution_db
      DATABASE_CONNECTION_CLIENT_NAME: evolution_api
      DATABASE_SAVE_DATA_INSTANCE: true
      DATABASE_SAVE_DATA_NEW_MESSAGE: true
      DATABASE_SAVE_MESSAGE_UPDATE: true
      DATABASE_SAVE_DATA_CONTACTS: true
      DATABASE_SAVE_DATA_CHATS: true

      # Redis connection
      REDIS_URI: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PREFIX_KEY: evolution

      # Evolution API configuration
      SERVER_URL: https://${EVOLUTION_HOST}
      SERVER_PORT: 8080

      # Authentication
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY}
      AUTHENTICATION_INSTANCE_ENABLED: true

      # Webhook configuration
      WEBHOOK_GLOBAL_ENABLED: true
      WEBHOOK_GLOBAL_URL: https://${N8N_HOST}/webhook/whatsapp-incoming
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: true

      # WhatsApp session configuration
      CONFIG_SESSION_PHONE_CLIENT: BorgStack WhatsApp Gateway
      CONFIG_SESSION_PHONE_NAME: BorgStack

      # QR code customization
      QRCODE_COLOR: '#198754'
      QRCODE_LIMIT: 30

      # Log level
      LOG_LEVEL: ERROR
      LOG_COLOR: true

    volumes:
      - borgstack_evolution_instances:/evolution/instances
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  borgstack_evolution_instances:
    driver: local
```

**Critical Configuration Notes:**
- Evolution API needs TWO networks: `borgstack_internal` (DB/Redis) and `borgstack_external` (Caddy proxy) [Source: architecture/coding-standards.md#network-isolation]
- Volume name uses `borgstack_` prefix per coding standards [Source: architecture/coding-standards.md#volume-naming-convention]
- Restart policy `unless-stopped` for automatic recovery [Source: architecture/coding-standards.md#critical-infrastructure-rules]
- Health check tests root endpoint `/` on port 8080 (Evolution API v2.2.3 does not document a dedicated `/health` endpoint, but responds 200 OK at root)
- Depends on PostgreSQL and Redis with `service_healthy` condition
- Prisma migrations run automatically on first startup (60s start_period accommodates this)

### Caddy Reverse Proxy Configuration

**Caddyfile Block for Evolution API** [Source: architecture/components.md#caddy]

**Already configured in config/caddy/Caddyfile:**
```
# Evolution API - WhatsApp Business API Gateway
evolution.{$DOMAIN} {
    reverse_proxy evolution:8080

    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Automatic HTTPS via Let's Encrypt
    tls {$CADDY_EMAIL}
}
```

**API Access URLs:**
- Admin UI: `https://evolution.${DOMAIN}/manager`
- API Documentation: `https://evolution.${DOMAIN}/docs`
- Root/Health Check: `https://evolution.${DOMAIN}/` (returns 200 OK when healthy)
- Instance Creation: `POST https://evolution.${DOMAIN}/instance/create`
- Send Message: `POST https://evolution.${DOMAIN}/message/sendText/{instanceName}`

### Coding Standards Compliance

**Volume Naming Convention** [Source: architecture/coding-standards.md]
- Volume must be named: `borgstack_evolution_instances`
- Prefix `borgstack_` required to prevent conflicts with other Docker stacks
- Volume type: Named volume with local driver

**Network Configuration** [Source: architecture/coding-standards.md]
- Evolution API must be on BOTH networks:
  - `borgstack_internal`: For database and Redis access
  - `borgstack_external`: For Caddy reverse proxy access
- Rationale: Evolution API needs DB/Redis internally + external HTTPS access via Caddy + webhook delivery to n8n

**Health Check Requirements** [Source: architecture/coding-standards.md]
- All long-running services must define health checks
- Evolution API health check: `wget --quiet --tries=1 --spider http://localhost:8080/ || exit 1` (root endpoint - v2.2.3 has no documented /health endpoint)
- Enables proper startup ordering with `depends_on: { condition: service_healthy }`

**Dependency Management** [Source: architecture/coding-standards.md]
- Evolution API depends on PostgreSQL (must be healthy before Evolution API starts)
- Evolution API depends on Redis (must be healthy before Evolution API starts)
- Use `depends_on` with `condition: service_healthy` for proper sequencing

**Environment Variable Security** [Source: architecture/coding-standards.md]
- Never commit `.env` files or secrets to git
- Use `.env.example` as template with placeholder values
- `.gitignore` must exclude `.env` files (already configured in Story 1.1)

### File Locations

**New Files to Create:**
- `config/evolution/README.md` - WhatsApp instance setup and integration guide
- `config/n8n/workflows/03-whatsapp-evolution-incoming.json` - n8n webhook workflow for incoming WhatsApp messages
- `tests/deployment/verify-evolution.sh` - Evolution API validation tests

**Files to Modify:**
- `docker-compose.yml` - Add Evolution API service definition
- `.env.example` - Add EVOLUTION_* variables
- `scripts/bootstrap.sh` - Add Evolution API password generation
- `.github/workflows/ci.yml` - Add Evolution API validation jobs
- `README.md` - Document Evolution API service

**Already Configured (Verify Only):**
- `config/postgresql/init-databases.sql` - evolution_db and evolution_user already configured (Story 1.3)
- `config/caddy/Caddyfile` - Evolution API reverse proxy block already configured (Story 1.5)

**File Path Standards** [Source: architecture/unified-project-structure.md]
- Configuration files: `config/<service>/` directory
- Test scripts: `tests/deployment/` and `tests/integration/`
- Scripts: `scripts/` directory with kebab-case naming

### Tech Stack Context

**Evolution API Version Selection** [Source: architecture/tech-stack.md]
- Version: Evolution API v2.2.3 (`atendai/evolution-api:v2.2.3` Docker image)
- Rationale: Multi-instance WhatsApp Business API gateway; enables WhatsApp workflows
- Image source: Official AtendAI Docker Hub repository
- Backend: Node.js + Express + Prisma ORM (internal to container)

**WhatsApp Business API Integration** [Source: architecture/external-apis.md#whatsapp-business-api]
- Meta WhatsApp Cloud API or self-hosted WhatsApp Business API Server
- Requires Meta Business Account, App, and verified phone number
- QR code authentication for WhatsApp connection
- Webhook-based message event delivery
- Rate limits: 80 messages/second per phone number (business messages)

**Related Infrastructure** [Source: architecture/tech-stack.md]
- Docker Compose v2 for orchestration
- Docker volumes for persistent storage (WhatsApp session data)
- Docker networks for service isolation (`borgstack_internal`, `borgstack_external`)

### Security Requirements

**Evolution API Security Configuration** [Source: architecture/coding-standards.md, architecture/tech-stack.md]

1. **API Authentication:**
   - Global API key enabled (AUTHENTICATION_API_KEY)
   - Instance-level authentication enabled (AUTHENTICATION_INSTANCE_ENABLED)
   - Strong API key (32-character alphanumeric)
   - All API requests require `apikey` header

2. **Database Security:**
   - Dedicated database user (evolution_user) with access ONLY to evolution_db
   - Strong password (32-character alphanumeric)
   - PostgreSQL connection over internal Docker network (no host exposure)

3. **Network Isolation:**
   - Database and Redis accessible only on `borgstack_internal` network
   - Admin UI exposed via Caddy on `borgstack_external` with HTTPS
   - Webhook endpoints protected by HTTPS (automatic Let's Encrypt SSL)

4. **Credential Management:**
   - Passwords stored in .env file with 600 permissions
   - Strong password generation: 32-character alphanumeric via `openssl rand -base64 32`
   - Never commit .env to version control (enforced by .gitignore)

5. **WhatsApp Session Security:**
   - Session data encrypted in volume `borgstack_evolution_instances`
   - QR code expires after 30 seconds (QRCODE_LIMIT=30)
   - Instance isolation: Each business account has separate session

### Instance Creation API Specification

**Evolution API Instance Creation Endpoint** [Source: Evolution API v2 Documentation - https://doc.evolution-api.com/v2/api-reference/instance-controller/create-instance-basic]

**Endpoint:** `POST /instance/create`

**Headers:**
```
Content-Type: application/json
apikey: {EVOLUTION_API_KEY}
```

**Request Body (Minimal - Only Required Fields):**
```json
{
  "instanceName": "customer_support",
  "integration": "WHATSAPP-BAILEYS"
}
```

**Request Body (Complete with Webhook Configuration):**
```json
{
  "instanceName": "customer_support",
  "qrcode": true,
  "integration": "WHATSAPP-BAILEYS",
  "webhook": {
    "url": "https://{N8N_HOST}/webhook/whatsapp-incoming",
    "byEvents": true,
    "events": [
      "MESSAGES_UPSERT",
      "MESSAGES_UPDATE",
      "CONNECTION_UPDATE"
    ]
  }
}
```

**Optional Parameters:**
- `token`: Custom authentication token for this instance
- `qrcode`: Boolean to enable QR code generation (default: true)
- `number`: Phone number to connect (alternative to QR code)
- `rejectCall`: Reject incoming calls automatically
- `msgCall`: Message to send when rejecting calls
- `groupsIgnore`: Ignore group messages
- `alwaysOnline`: Keep instance always online
- `readMessages`: Auto-read messages
- `readStatus`: Auto-read status updates
- `syncFullHistory`: Sync full WhatsApp message history
- `webhook.url`: Webhook URL for receiving events
- `webhook.byEvents`: Enable event-based webhooks
- `webhook.base64`: Send media as base64 in webhooks
- `webhook.events`: Array of events to receive (e.g., "MESSAGES_UPSERT", "CONNECTION_UPDATE")

**Response (Success - 200 OK):**
```json
{
  "instance": {
    "instanceName": "customer_support",
    "instanceId": "af6c5b7c-ee27-4f94-9ea8-192393746ddd",
    "status": "created"
  },
  "hash": {
    "apikey": "auto-generated-key-if-not-provided"
  },
  "settings": {
    "reject_call": false,
    "msg_call": "",
    "groups_ignore": true,
    "always_online": false,
    "read_messages": false,
    "read_status": false,
    "sync_full_history": false
  }
}
```

### Integration with n8n

**Evolution API → n8n Webhook Flow** [Source: architecture/data-models.md#integration-payload-examples]

**1. Incoming WhatsApp Message Webhook (Evolution API → n8n):**
```json
POST https://{N8N_HOST}/webhook/whatsapp-incoming
Content-Type: application/json

{
  "event": "messages.upsert",
  "instance": "customer_support",
  "data": {
    "key": {
      "remoteJid": "5511987654321@s.whatsapp.net",
      "fromMe": false,
      "id": "3EB0C8F3E7E3A7D8C0F1"
    },
    "message": {
      "conversation": "Olá, preciso de ajuda com meu pedido #12345"
    },
    "messageTimestamp": 1735632000,
    "pushName": "João Silva"
  }
}
```

**2. Send WhatsApp Message (n8n → Evolution API):**
```json
POST https://{EVOLUTION_HOST}/message/sendText/{instanceName}
apikey: {EVOLUTION_API_KEY}
Content-Type: application/json

{
  "number": "5511987654321",
  "text": "Olá! Recebemos sua mensagem e estamos verificando seu pedido.",
  "delay": 1000
}
```

**n8n Workflow JSON Structure for Incoming WhatsApp Messages:**

The `config/n8n/workflows/03-whatsapp-evolution-incoming.json` workflow should follow this structure (based on n8n webhook pattern from `01-webhook-test.json`):

```json
{
  "name": "03 - WhatsApp Evolution Incoming",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-incoming",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Evolution Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "whatsapp-evolution"
    },
    {
      "parameters": {
        "functionCode": "// Extract WhatsApp message data\nconst event = $json.event;\nconst instanceName = $json.instance;\nconst messageData = $json.data;\n\nreturn {\n  event: event,\n  instance: instanceName,\n  remoteJid: messageData.key.remoteJid,\n  phoneNumber: messageData.key.remoteJid.split('@')[0],\n  messageText: messageData.message.conversation,\n  messageId: messageData.key.id,\n  timestamp: messageData.messageTimestamp,\n  senderName: messageData.pushName\n};"
      },
      "id": "function-node",
      "name": "Process Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"received\": $json.messageId } }}"
      },
      "id": "respond-node",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [650, 300]
    }
  ],
  "connections": {
    "Evolution Webhook": {
      "main": [[{"node": "Process Message", "type": "main", "index": 0}]]
    },
    "Process Message": {
      "main": [[{"node": "Respond to Webhook", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
```

**n8n Workflow Components:**
- **Webhook node**: Receives Evolution API message events at `/webhook/whatsapp-incoming`
- **Function node**: Processes incoming message (extract phone, text, metadata)
- **Respond to Webhook node**: Sends 200 OK response to Evolution API
- **Additional nodes** (optional): HTTP Request node to send response via Evolution API, error handling with retry logic (3 attempts, exponential backoff)

### Testing

**Testing Strategy** [Source: architecture/testing-strategy.md]

**Testing Philosophy:**
- No unit tests (Evolution API is pre-built Docker image)
- Focus: Configuration verification and deployment validation
- Verify Evolution API container runs, health checks pass, and integrations work

**Required Validation Tests (create in `tests/deployment/verify-evolution.sh`):**

1. **Test 1: Container Running**
   - Command: `docker compose ps evolution | grep -q "Up"`
   - Expected: Evolution API container in "Up" state

2. **Test 2: Health Check Passing**
   - Command: `docker compose ps evolution | grep -q "healthy"`
   - Expected: Container marked as healthy

3. **Test 3: Database Connection**
   - Command: `docker compose logs evolution | grep -q "Prisma migration completed"`
   - Expected: Prisma migrations successful

4. **Test 4: Redis Connection**
   - Command: `docker compose logs evolution | grep -q "Redis connected"`
   - Expected: Redis connection established

5. **Test 5: Web UI Accessible via HTTPS**
   - Command: `curl -f -k https://${EVOLUTION_HOST}/manager | grep -q "Evolution API"`
   - Expected: Evolution API admin UI responds with HTTP 200

6. **Test 6: API Authentication**
   - Command: `curl -f https://${EVOLUTION_HOST}/ -H "apikey: ${EVOLUTION_API_KEY}"`
   - Expected: Root endpoint returns 200 OK response with valid API key

7. **Test 7: Volume Persistence**
   - Command: `docker volume ls | grep -q borgstack_evolution_instances`
   - Expected: Volume exists

8. **Test 8: Instance Creation API**
   - Command: `curl -f -X POST https://${EVOLUTION_HOST}/instance/create -H "apikey: ${EVOLUTION_API_KEY}" -d '{"instanceName":"test"}'`
   - Expected: Instance created successfully

**Integration with CI:**
- Add Evolution API validation job to `.github/workflows/ci.yml`
- Run `docker compose config` to validate Evolution API service syntax
- Validate Evolution API environment variables are properly configured

**Success Criteria:**
- All 8 validation tests pass
- Evolution API accessible via HTTPS with API authentication
- Database and Redis connections working
- Persistent volume mounted and data survives container restart
- Health check reports healthy status within 60 seconds of startup
- Instance creation API functional

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation with comprehensive architecture context | Bob (Scrum Master) |
| 2025-10-02 | 1.1 | PO validation corrections applied: Fixed CRIT-001 (health check endpoint uses `/` instead of undocumented `/health`), CRIT-002 (added complete instance creation API specification from Evolution API v2 docs), SHOULD-001 (split Task 5 into verification and testing), SHOULD-002 (added n8n webhook workflow JSON structure), SHOULD-003 (added DATABASE_CONNECTION_CLIENT_NAME to Task 4) | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
