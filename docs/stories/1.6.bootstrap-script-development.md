# Story 1.6: Bootstrap Script Development (Epic 1 - Foundation & Core Infrastructure)

## Status
Draft

## Story
**As a** deployment specialist,
**I want** an automated bootstrap script for Ubuntu 24.04 LTS,
**so that** users can deploy the entire stack with minimal manual intervention.

## Acceptance Criteria
1. Bootstrap script checks system requirements
2. Docker and Docker Compose v2 automatically installed
3. Required system dependencies installed
4. Environment variables template (.env.example) created with prompts
5. Script validates installation with health checks
6. Script outputs next steps for SSL configuration via Caddy
7. Documentation for manual SSL setup provided

## Tasks / Subtasks

- [ ] Create bootstrap.sh script with system requirements validation (AC: 1)
  - [ ] Create `scripts/bootstrap.sh` with proper shebang and error handling
  - [ ] Check Ubuntu version (must be 24.04 LTS)
  - [ ] Check available RAM (minimum 16GB, recommend 36GB for production)
  - [ ] Check available disk space (minimum 200GB, recommend 500GB for production)
  - [ ] Check CPU cores (minimum 4 vCPUs, recommend 8 vCPUs for production)
  - [ ] Exit with clear error message if requirements not met
  - [ ] Make script executable (chmod +x scripts/bootstrap.sh)

- [ ] Implement Docker and Docker Compose v2 installation (AC: 2)
  - [ ] Check if Docker Engine is already installed
  - [ ] If not installed, add Docker's official GPG key
  - [ ] Add Docker's official APT repository for Ubuntu 24.04
  - [ ] Install Docker Engine latest stable version
  - [ ] Install Docker Compose v2 plugin
  - [ ] Add current user to docker group for non-root access
  - [ ] Start and enable Docker service
  - [ ] Verify installation: `docker --version` and `docker compose version`

- [ ] Install required system dependencies (AC: 3)
  - [ ] Update APT package index: `sudo apt update`
  - [ ] Install essential packages: curl, wget, git, ufw (firewall)
  - [ ] Install DNS utilities: dig, nslookup for DNS verification
  - [ ] Install system monitoring tools: htop, iostat (sysstat package)
  - [ ] Verify all installations successful

- [ ] Configure firewall with UFW (AC: 3)
  - [ ] Set UFW default policies: deny incoming, allow outgoing
  - [ ] Allow SSH port 22 (warn user to change if using custom SSH port)
  - [ ] Allow HTTP port 80 (for Let's Encrypt ACME challenge)
  - [ ] Allow HTTPS port 443 (for Caddy reverse proxy)
  - [ ] Enable UFW firewall
  - [ ] Display UFW status to user

- [ ] Implement interactive .env generation (AC: 4)
  - [ ] Check if .env file already exists (skip if exists, warn user)
  - [ ] Copy .env.example to .env
  - [ ] Prompt user for DOMAIN (base domain for all services)
  - [ ] Prompt user for EMAIL (for Let's Encrypt SSL notifications)
  - [ ] Generate strong random passwords for all services (minimum 16 characters, alphanumeric + special chars)
  - [ ] Set PostgreSQL passwords: POSTGRES_PASSWORD, N8N_DB_PASSWORD, CHATWOOT_DB_PASSWORD, DIRECTUS_DB_PASSWORD, EVOLUTION_DB_PASSWORD
  - [ ] Set MongoDB credentials: MONGO_INITDB_ROOT_USERNAME, MONGO_INITDB_ROOT_PASSWORD
  - [ ] Set Redis password: REDIS_PASSWORD
  - [ ] Set application secrets: N8N_ENCRYPTION_KEY, CHATWOOT_SECRET_KEY_BASE, DIRECTUS_SECRET
  - [ ] Set CORS_ALLOWED_ORIGINS to "*" (development default, warn user to change for production)
  - [ ] Write all variables to .env file
  - [ ] Set .env file permissions to 600 (readable only by owner)
  - [ ] Display summary of generated credentials to user (warn to save in password manager)

- [ ] Implement deployment validation and health checks (AC: 5)
  - [ ] Pull all Docker images: `docker compose pull`
  - [ ] Verify all images pulled successfully
  - [ ] Start all services: `docker compose up -d`
  - [ ] Wait for services to initialize (60 seconds)
  - [ ] Check container health status: `docker compose ps`
  - [ ] Verify Caddy is healthy and running
  - [ ] Verify PostgreSQL is healthy and accepting connections
  - [ ] Verify Redis is healthy and accepting connections
  - [ ] Display service status summary to user
  - [ ] If any service fails health check, display troubleshooting instructions

- [ ] Display next steps and SSL configuration instructions (AC: 6)
  - [ ] Display success message with deployment summary
  - [ ] Explain DNS A record configuration requirements for all 7 subdomains
  - [ ] Provide example DNS records with user's domain from .env
  - [ ] Explain Let's Encrypt automatic SSL certificate generation
  - [ ] Explain 30-60 second wait time per subdomain on first access
  - [ ] Provide DNS verification command: `dig <subdomain>.<domain> +short`
  - [ ] Display access URLs for all services (https://<service>.<domain>)
  - [ ] Remind user to save generated passwords from .env file
  - [ ] Display estimated deployment time (4-6 hours for full stack setup)

- [ ] Create bootstrap script documentation (AC: 7)
  - [ ] Document manual installation steps for advanced users in README.md
  - [ ] Document DNS configuration requirements with examples
  - [ ] Document firewall configuration for custom setups
  - [ ] Document manual SSL setup for non-Let's Encrypt scenarios
  - [ ] Document troubleshooting common bootstrap failures
  - [ ] Add inline comments to bootstrap.sh explaining each step

## Dev Notes

### Previous Story Insights
[Source: Story 1.5 completion notes]
- Environment variables should have defaults for testing where possible
- Comprehensive inline documentation is critical for maintainability
- Security configurations (like CORS) should be documented with warnings
- All configurations must be validated before deployment
- CI integration ensures scripts remain functional across changes

### Tech Stack Requirements
[Source: architecture/tech-stack.md]

**Operating System:**
- Ubuntu Server LTS 24.04 (Long-term support until 2029)
- Excellent Docker compatibility
- Bash 5.x (Ubuntu default) for scripting

**Required Software:**
- Docker Engine: Latest stable version (installed by bootstrap script)
- Docker Compose: v2 (latest) - Plugin architecture, not standalone binary
- Git: Latest stable (for repository cloning)
- UFW (Uncomplicated Firewall): For firewall management

**Minimum Server Requirements (Testing):**
- 4 vCPUs
- 16GB RAM
- 200GB SSD storage

**Recommended Server Requirements (Production):**
- 8 vCPUs
- 36GB RAM
- 500GB SSD storage

### Project Structure Alignment
[Source: architecture/unified-project-structure.md, architecture/source-tree.md]

**Bootstrap Script Location:**
```
borgstack/
├── scripts/
│   ├── bootstrap.sh              # Ubuntu 24.04 automated setup (THIS STORY)
│   ├── healthcheck.sh            # Post-deployment verification (Future: Story 6.1)
│   ├── backup-now.sh             # Manual backup trigger (Future: Story 5.2)
│   ├── restore.sh                # Disaster recovery script (Future: Story 5.2)
│   ├── update-service.sh         # Individual service update (Future: Story 6.5)
│   └── generate-env.sh           # Interactive .env generator (Future: Story 6.2)
```

**Note:** This is the FIRST script to be created in the scripts/ directory. Directory currently exists with .gitkeep only.

### Deployment Checklist Requirements
[Source: architecture/deployment-architecture.md#deployment-checklist]

**Pre-Deployment Validations (Bootstrap Script Must Check):**
1. Server running Ubuntu 24.04 LTS (exact version match required)
2. Server meets resource requirements (CPU, RAM, disk space)
3. DNS A records configured pointing to server IP (user responsibility, script reminds)
4. Firewall configuration (script automates with UFW)
5. Non-root user with sudo privileges (script assumes user has sudo)
6. Docker and Docker Compose v2 installed (script automates)

**Deployment Steps (Bootstrap Script Must Execute):**
1. Install Docker Engine and Docker Compose v2
2. Install required system dependencies
3. Configure UFW firewall rules
4. Generate .env file with strong passwords
5. Pull all Docker images
6. Start all services
7. Validate service health checks
8. Display next steps (DNS, SSL, admin access)

**Post-Deployment Instructions (Bootstrap Script Must Display):**
1. DNS A record configuration for 7 subdomains
2. SSL certificate automatic generation explanation
3. Admin account creation for each service
4. Password management recommendations
5. Service access URLs

### Environment Variable Requirements
[Source: .env.example from Stories 1.3, 1.4, 1.5]

**Environment Variables to Generate:**

**PostgreSQL Database (Story 1.3):**
- POSTGRES_PASSWORD (16+ chars, strong password)
- N8N_DB_PASSWORD (16+ chars, strong password)
- CHATWOOT_DB_PASSWORD (16+ chars, strong password)
- DIRECTUS_DB_PASSWORD (16+ chars, strong password)
- EVOLUTION_DB_PASSWORD (16+ chars, strong password)

**MongoDB Database (Story 1.7):**
- MONGO_INITDB_ROOT_USERNAME (default: mongoadmin)
- MONGO_INITDB_ROOT_PASSWORD (16+ chars, strong password)

**Redis Cache (Story 1.4):**
- REDIS_PASSWORD (16+ chars, strong password)

**Caddy Reverse Proxy (Story 1.5):**
- DOMAIN (user input required, e.g., example.com.br)
- EMAIL (user input required, e.g., admin@example.com.br)
- CORS_ALLOWED_ORIGINS (default "*" for development, warn for production)

**Application Secrets (Future Stories):**
- N8N_ENCRYPTION_KEY (32+ chars, hex or base64)
- CHATWOOT_SECRET_KEY_BASE (64+ chars)
- DIRECTUS_SECRET (32+ chars)
- EVOLUTION_JWT_SECRET (32+ chars)

**Password Generation Requirements:**
[Source: architecture/security-and-performance.md#password-policy]
- Minimum 12 characters (recommend 16 for automation)
- Must include uppercase, lowercase, numbers, special characters
- Use strong random generation (e.g., /dev/urandom, openssl rand)
- Each service must have unique password (no reuse)

**Password Generation Implementation:**
Use the following bash function for consistent password generation:
```bash
generate_password() {
  # Generate 32-character password using OpenSSL
  # Remove problematic characters (=, +, /) that may cause issues in .env files
  openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
}

# Usage example:
POSTGRES_PASSWORD=$(generate_password)
```
This method ensures:
- Strong entropy from OpenSSL's cryptographic random number generator
- 32 characters length (exceeds minimum requirement)
- Alphanumeric characters only (no special chars that break .env parsing)
- Consistent format across all generated passwords

### Security Requirements
[Source: architecture/security-and-performance.md#network-security, #data-security]

**Firewall Configuration (UFW):**
```bash
# Default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH (port 22, adjust if using custom port)
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS for Caddy
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable
```

**Secret Management:**
- Never commit .env files to git (already in .gitignore from Story 1.1)
- Set .env file permissions to 600 (readable only by owner)
- Use strong, unique passwords for each service (minimum 12 characters, recommend 16+)
- Display warning to user: Save passwords in secure password manager (e.g., 1Password, Bitwarden)
- Recommend credential rotation every 90 days

**Encryption at Rest:**
- .env file: 600 permissions enforced by script
- Backup encryption: Duplicati (Story 5.2 handles this)
- Full disk encryption (LUKS): Optional, recommended for production (bootstrap script should suggest)

### Docker Installation Requirements
[Source: Docker official documentation for Ubuntu - https://docs.docker.com/engine/install/ubuntu/]
[Architecture Reference: architecture/tech-stack.md specifies "Docker Engine: Latest stable version"]

**Docker Engine Installation Steps (Ubuntu 24.04):**
```bash
# Remove old Docker versions if present
sudo apt remove docker docker-engine docker.io containerd runc

# Install dependencies
sudo apt update
sudo apt install ca-certificates curl gnupg

# Add Docker's official GPG key
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Add Docker APT repository
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker Engine and Compose plugin
sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add user to docker group (non-root access)
sudo usermod -aG docker $USER

# Start and enable Docker service
sudo systemctl start docker
sudo systemctl enable docker

# Verify installation
docker --version
docker compose version
```

**IMPORTANT:** Use `docker compose` (v2 plugin) NOT `docker-compose` (v1 standalone binary)

### DNS Configuration Requirements
[Source: architecture/deployment-architecture.md#deployment-checklist, Story 1.5]

**Required DNS A Records (7 subdomains):**
```
n8n.<DOMAIN>        IN  A  <SERVER_IP>
chatwoot.<DOMAIN>   IN  A  <SERVER_IP>
evolution.<DOMAIN>  IN  A  <SERVER_IP>
lowcoder.<DOMAIN>   IN  A  <SERVER_IP>
directus.<DOMAIN>   IN  A  <SERVER_IP>
fileflows.<DOMAIN>  IN  A  <SERVER_IP>
duplicati.<DOMAIN>  IN  A  <SERVER_IP>
```

**DNS Verification Command:**
```bash
dig n8n.<DOMAIN> +short
# Should return <SERVER_IP>
```

**SSL Certificate Requirements:**
- Let's Encrypt automatic SSL via Caddy (Story 1.5 configured this)
- Port 80 must be open for ACME HTTP-01 challenge
- Port 443 must be open for HTTPS access
- Certificates generated automatically on first request to each subdomain
- 30-60 second delay per domain on first access
- Caddy handles automatic renewal (30 days before expiration)

### Health Check Requirements
[Source: architecture/coding-standards.md#health-check-requirements]

**Services with Health Checks (Defined in docker-compose.yml):**
1. Caddy: HTTP request to admin API (port 2019)
2. PostgreSQL: `pg_isready -U postgres`
3. MongoDB: `mongosh --eval "db.adminCommand('ping')"`
4. Redis: `redis-cli ping`

**Bootstrap Script Validation:**
- Wait 60 seconds after `docker compose up -d` for service initialization
- Check `docker compose ps` output for health status
- Services should show "healthy" status
- If any service shows "unhealthy", display troubleshooting message

### Error Handling and User Experience
[Source: architecture/development-workflow.md, architecture/error-handling-strategy.md]

**Script Error Handling Best Practices:**
- Use `set -euo pipefail` at script start (exit on error, undefined vars, pipe failures)
- Provide clear error messages with actionable instructions
- Use color coding for output: Green (success), Yellow (warning), Red (error)
- Display progress indicators for long-running operations
- Log all actions to `/tmp/borgstack-bootstrap.log` for troubleshooting
- Provide summary at end: Success/failure status, next steps

**User Prompts:**
- Default values for non-sensitive inputs (e.g., DOMAIN placeholder)
- Clear explanations for each prompt
- Validation of user input (e.g., domain format validation)
- Confirmation before destructive actions (e.g., overwriting .env)

### Coding Standards
[Source: architecture/coding-standards.md]

**Shell Script Naming:**
- File: `bootstrap.sh` (kebab-case.sh convention)
- Location: `scripts/bootstrap.sh`
- Executable: `chmod +x scripts/bootstrap.sh`

**Shell Script Best Practices:**
- Shebang: `#!/usr/bin/env bash`
- Error handling: `set -euo pipefail`
- Functions for reusable logic
- Clear inline comments explaining each section
- Color output for readability (tput colors)
- Progress indicators for user feedback

**Git Commit Standards:**
- Imperative mood, lowercase
- Example: `add bootstrap script for ubuntu 24.04 automated setup`

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Testing Philosophy:**
- **No unit tests**: Bootstrap script is Bash; focus on integration validation
- **Deployment validation**: Ensure script successfully sets up environment
- **Idempotency testing**: Script should be safe to run multiple times
- **Failure scenario testing**: Verify graceful error handling

### Test Requirements

**Test 1: Ubuntu Version Validation**
```bash
# Verify script detects Ubuntu 24.04 LTS
./scripts/bootstrap.sh
# Expected: Success on Ubuntu 24.04, clear error on other versions
```

**Test 2: System Requirements Check**
```bash
# Verify script validates RAM, CPU, disk space
./scripts/bootstrap.sh
# Expected: Exit with error if requirements not met, display current vs required values
```

**Test 3: Docker Installation Verification**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify Docker installed
docker --version
# Expected: Docker version 20.x or higher

# Verify Docker Compose v2 installed
docker compose version
# Expected: Docker Compose version v2.x.x

# Verify user in docker group
groups | grep docker
# Expected: docker group listed
```

**Test 4: Firewall Configuration Verification**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify UFW enabled and configured
sudo ufw status
# Expected: Status: active
# Expected: 22/tcp ALLOW
# Expected: 80/tcp ALLOW
# Expected: 443/tcp ALLOW
```

**Test 5: .env File Generation and Security**
```bash
# Run bootstrap script with test inputs
./scripts/bootstrap.sh

# Verify .env file created
ls -la .env
# Expected: File exists with 600 permissions (-rw-------)

# Verify all required variables set
grep -q "POSTGRES_PASSWORD" .env
grep -q "DOMAIN" .env
grep -q "EMAIL" .env
# Expected: All variables found

# Verify passwords are strong (16+ chars)
grep "POSTGRES_PASSWORD" .env | wc -c
# Expected: > 20 characters (16 for password + variable name + =)
```

**Test 6: Docker Image Pull Verification**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify all images pulled
docker images | grep caddy
docker images | grep pgvector
docker images | grep mongo
docker images | grep redis
# Expected: All core infrastructure images present
```

**Test 7: Service Health Check Validation**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify services are healthy
docker compose ps
# Expected: All services show "Up" status
# Expected: Health check shows "healthy" for services with health checks

# Verify Caddy is running
docker compose ps caddy | grep "Up"
# Expected: Caddy running

# Verify PostgreSQL is healthy
docker compose exec postgresql pg_isready -U postgres
# Expected: "accepting connections"

# Verify Redis is healthy
docker compose exec redis redis-cli ping
# Expected: "PONG"
```

**Test 8: Idempotency Testing**
```bash
# Run bootstrap script first time
./scripts/bootstrap.sh

# Run bootstrap script second time
./scripts/bootstrap.sh
# Expected: Script detects existing installation
# Expected: Skips Docker installation if already installed
# Expected: Warns about existing .env file, skips generation
# Expected: No errors, graceful handling of existing setup
```

**Test 9: DNS Configuration Instructions**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify DNS instructions displayed
# Expected: 7 subdomain examples shown with user's domain
# Expected: dig verification command shown
# Expected: SSL certificate explanation shown
```

**Test 10: DNS Configuration Verification**
```bash
# Run bootstrap script
./scripts/bootstrap.sh

# Verify DNS records are configured for all 7 subdomains
DOMAIN=$(grep "^DOMAIN=" .env | cut -d= -f2)

for subdomain in n8n chatwoot evolution lowcoder directus fileflows duplicati; do
  echo "Checking DNS for ${subdomain}.${DOMAIN}..."
  IP=$(dig ${subdomain}.${DOMAIN} +short)

  if [ -z "$IP" ]; then
    echo "❌ WARNING: DNS not configured for ${subdomain}.${DOMAIN}"
  else
    echo "✅ DNS configured: ${subdomain}.${DOMAIN} → ${IP}"
  fi
done

# Expected: All 7 subdomains return server IP address
# If any subdomain returns empty: DNS not configured, SSL generation will fail
# Script should warn user but not block deployment (DNS can be configured after)
```

**Test 11: Error Handling and Rollback**
```bash
# Simulate failure scenario (e.g., insufficient disk space)
# Run bootstrap script
./scripts/bootstrap.sh
# Expected: Clear error message
# Expected: Actionable troubleshooting steps
# Expected: Log file location displayed: /tmp/borgstack-bootstrap.log
```

### Test Script Location
**No automated test script required** for bootstrap.sh (manual validation during QA)

Manual testing on clean Ubuntu 24.04 VM recommended.

### CI Integration
**No CI integration required** for bootstrap script (runs on production server, not in CI environment)

Bootstrap script will be documented in README.md with manual testing instructions.

### Success Criteria

**All Acceptance Criteria Met:**
- AC1: Bootstrap script checks system requirements ✓
- AC2: Docker and Docker Compose v2 automatically installed ✓
- AC3: Required system dependencies installed ✓
- AC4: Environment variables template (.env.example) created with prompts ✓
- AC5: Script validates installation with health checks ✓
- AC6: Script outputs next steps for SSL configuration via Caddy ✓
- AC7: Documentation for manual SSL setup provided ✓

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
