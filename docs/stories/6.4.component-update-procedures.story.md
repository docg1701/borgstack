# Story 6.4: Component Update Procedures

## Status
Approved

## Story
**As a** system administrator,
**I want** documented procedures for updating individual components,
**so that** I can maintain the system without breaking integrations.

## Acceptance Criteria
1. Individual component update process documented
2. Version pinning strategy documented in docker-compose.yml
3. Rollback procedure for failed updates
4. Pre-update backup verification checklist
5. Common update issues and solutions documented
6. Update notification strategy defined

## Tasks / Subtasks

- [ ] **Task 0: Review Existing Update Documentation** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Review docs/06-manutencao.md sections 2.1, 2.2, 2.3
  - [ ] Review docs/architecture/coding-standards.md version pinning section
  - [ ] Identify gaps against each AC:
    - [ ] AC1 (Individual update process): PARTIAL - section 2.3 exists but needs expansion
    - [ ] AC2 (Version pinning strategy): COMPLETE - coding-standards.md documents this
    - [ ] AC3 (Rollback procedure): COMPLETE - section 2.2 step 8 covers this
    - [ ] AC4 (Pre-update backup checklist): COMPLETE - section 2.2 step 3 covers this
    - [ ] AC5 (Common update issues): MISSING - needs dedicated troubleshooting section
    - [ ] AC6 (Update notification strategy): MISSING - needs section on checking for updates

- [ ] **Task 1: Create update-service.sh Script** (AC: 1)
  - [ ] Script location: scripts/update-service.sh
  - [ ] **Input parameters:**
    - [ ] SERVICE_NAME (required): Name of service to update (e.g., n8n, chatwoot, postgresql)
    - [ ] NEW_VERSION (optional): Target version (e.g., 1.113.0), defaults to "latest available"
  - [ ] **Script workflow:**
    - [ ] Step 1: Validate service name exists in docker-compose.yml
    - [ ] Step 2: Check current version vs. requested version
    - [ ] Step 3: Display changelog URL for manual review
    - [ ] Step 4: Prompt for confirmation (Y/n)
    - [ ] Step 5: Create automatic backup of service data and configs
    - [ ] Step 6: Update docker-compose.yml with new version
    - [ ] Step 7: Pull new Docker image
    - [ ] Step 8: Recreate container with --force-recreate
    - [ ] Step 9: Monitor logs for 60 seconds
    - [ ] Step 10: Run health checks
    - [ ] Step 11: Report success or failure
    - [ ] Step 12: If failure, prompt for automatic rollback (Y/n)
  - [ ] **Error handling:**
    - [ ] Detect health check failures (retry 5x with 10s interval)
    - [ ] Detect startup failures (check logs for "error", "fatal", "panic")
    - [ ] Offer rollback option on any failure
  - [ ] **Logging:**
    - [ ] Log all actions to /var/log/borgstack-updates.log
    - [ ] Include timestamps, service name, old version, new version, status
    - [ ] Create /var/log directory if it doesn't exist with proper permissions
  - [ ] **Multi-container service handling:**
    - [ ] Detect services with multiple containers (e.g., Lowcoder has 3: api, node, frontend)
    - [ ] Update all containers atomically (all or nothing approach)
    - [ ] Verify all containers healthy before considering update successful
  - [ ] Make executable: chmod +x scripts/update-service.sh

- [ ] **Task 2: Enhance docs/06-manutencao.md with Update Troubleshooting** (AC: 5)
  - [ ] Add new section: "2.4. Solução de Problemas em Atualizações"
  - [ ] **Issue 1: Falha no Health Check Após Atualização**
    - [ ] Sintomas: Container em loop restart, status "unhealthy"
    - [ ] Diagnóstico: `docker compose logs SERVICE --tail=100`
    - [ ] Soluções comuns:
      1. Aguardar mais tempo (algumas migrações demoram)
      2. Verificar variáveis de ambiente (.env)
      3. Verificar conectividade com bancos de dados
      4. Rollback para versão anterior
    - [ ] Exemplo prático: n8n 1.62 → 1.63 migration delay
  - [ ] **Issue 2: Database Migration Failure**
    - [ ] Sintomas: Container para com erro de migration
    - [ ] Diagnóstico: `docker compose logs SERVICE | grep -i migration`
    - [ ] Soluções comuns:
      1. Verificar espaço em disco (migrations precisam de espaço temporário)
      2. Verificar permissões de banco de dados
      3. Restaurar backup e tentar novamente
      4. Consultar changelog para migrations conhecidas com problemas
    - [ ] Exemplo prático: Chatwoot database schema changes
  - [ ] **Issue 3: Breaking Changes em API**
    - [ ] Sintomas: Integrações param de funcionar após update
    - [ ] Diagnóstico: Revisar changelog para "BREAKING CHANGE"
    - [ ] Soluções comuns:
      1. Atualizar workflows n8n que usam API alterada
      2. Atualizar webhooks com novos formatos
      3. Ajustar configurações conforme documentação
    - [ ] Exemplo prático: Evolution API v2.0 → v2.2 webhook format change
  - [ ] **Issue 4: Incompatibilidade de Versão entre Serviços**
    - [ ] Sintomas: Serviços não conseguem se comunicar
    - [ ] Diagnóstico: Verificar versões de dependências (PostgreSQL, Redis)
    - [ ] Soluções comuns:
      1. Atualizar serviços em ordem: infraestrutura primeiro (PostgreSQL, Redis), aplicações depois
      2. Consultar matriz de compatibilidade nos changelogs
      3. Reverter para versões compatíveis
    - [ ] Exemplo prático: n8n requer PostgreSQL >= 13
  - [ ] **Issue 5: Perda de Configuração Após Update**
    - [ ] Sintomas: Configurações resetadas, credenciais perdidas
    - [ ] Diagnóstico: Verificar volumes montados (`docker volume ls`)
    - [ ] Soluções comuns:
      1. Verificar se volumes não foram removidos (`docker compose down -v` remove volumes!)
      2. Restaurar configuração do backup
      3. Verificar se paths de volumes mudaram no docker-compose.yml
    - [ ] Exemplo prático: Volume path change breaking configs
  - [ ] **Issue 6: Imagem Docker Não Disponível**
    - [ ] Sintomas: `docker compose pull` falha com "manifest unknown"
    - [ ] Diagnóstico: Verificar se versão existe no Docker Hub
    - [ ] Soluções comuns:
      1. Verificar typo no nome da versão (1.63.0 vs v1.63.0)
      2. Verificar se versão foi deprecated/removed
      3. Usar versão alternativa ou latest
    - [ ] Exemplo prático: Tag versioning differences between services
  - [ ] **Tabela de Referência Rápida:**
    - [ ] Create troubleshooting matrix table:
      | Erro | Serviço Comum | Comando Diagnóstico | Tempo Médio Resolução |
      |------|---------------|---------------------|----------------------|
      | Health check fail | Qualquer | `docker compose logs SERVICE` | 5-15 min |
      | Migration timeout | PostgreSQL apps | `docker compose exec postgresql psql -U postgres -c "\d+"` | 10-30 min |
      | API incompatibilidade | n8n, Evolution API | Revisar changelog | 15-60 min |
      | Volume missing | Qualquer | `docker volume ls \| grep borgstack` | 5-10 min (restaurar backup) |

- [ ] **Task 3: Enhance docs/06-manutencao.md with Update Notification Strategy** (AC: 6)
  - [ ] Add new section: "2.5. Estratégia de Notificação de Atualizações"
  - [ ] **Manual Check Strategy:**
    - [ ] Command: `docker compose pull --dry-run 2>&1 | grep "Pulling"`
    - [ ] Frequency: Weekly (add to weekly-check.sh script)
    - [ ] Output interpretation: List of services with available updates
  - [ ] **Automated Notification via Script:**
    - [ ] Create scripts/check-updates.sh:
      - [ ] Loop through all services in docker-compose.yml
      - [ ] For each service, compare current tag with DockerHub latest
      - [ ] Use Docker Hub API: `curl -s "https://hub.docker.com/v2/repositories/{image}/tags/?page_size=25"`
      - [ ] Support optional DOCKER_HUB_TOKEN environment variable for authenticated API calls
      - [ ] Implement exponential backoff for rate limiting (Docker Hub limits: 100 requests/6 hours unauthenticated)
      - [ ] Add fallback to `docker compose pull --dry-run` if API fails or rate limited
      - [ ] Parse JSON to find latest stable version (exclude alpha, beta, rc)
      - [ ] Generate report: SERVICE | CURRENT | LATEST | UPDATE_TYPE (major/minor/patch)
      - [ ] Document how to generate Docker Hub access token in script header comments
    - [ ] Email notification option:
      - [ ] If updates available, send email with report
      - [ ] Include changelog links for each update
      - [ ] Prioritize critical security updates (parse changelog for "security", "CVE")
    - [ ] Add to crontab: Weekly on Monday morning (0 9 * * 1)
  - [ ] **Changelog Monitoring:**
    - [ ] Document where to find changelogs for each service
    - [ ] Create table with changelog URLs:
      | Service | Changelog URL | RSS Feed Available |
      |---------|--------------|-------------------|
      | n8n | https://github.com/n8n-io/n8n/releases | Yes |
      | Chatwoot | https://github.com/chatwoot/chatwoot/releases | Yes |
      | Directus | https://github.com/directus/directus/releases | Yes |
      | Evolution API | https://github.com/EvolutionAPI/evolution-api/releases | Yes |
      | PostgreSQL | https://www.postgresql.org/docs/release/ | Yes |
      | (... continue for all 12 services) | | |
    - [ ] Recommend RSS feed subscription for critical services
  - [ ] **GitHub Watch Strategy:**
    - [ ] Recommend watching key repositories with "Releases only" notification
    - [ ] Prioritize: n8n, Chatwoot, Evolution API (most frequently updated)
  - [ ] **Security Update Monitoring:**
    - [ ] Subscribe to security mailing lists:
      - [ ] PostgreSQL security: https://www.postgresql.org/support/security/
      - [ ] Redis security: GitHub security advisories
      - [ ] Docker security: https://docs.docker.com/engine/security/
    - [ ] Document process for emergency security updates (skip staging, apply immediately with backup)

- [ ] **Task 4: Create Update Best Practices Section** (AC: 1, 2, 3)
  - [ ] Add new section: "2.6. Boas Práticas de Atualização"
  - [ ] **Best Practice 1: Version Pinning Strategy**
    - [ ] Reference docs/architecture/coding-standards.md section on version pinning
    - [ ] Explain rationale: Reproducible deployments, avoid surprise breaking changes
    - [ ] Example comparison:
      ```yaml
      # ❌ Wrong: Never use "latest"
      image: n8nio/n8n:latest

      # ✅ Correct: Pin exact version
      image: n8nio/n8n:1.112.6
      ```
    - [ ] Update workflow:
      1. Test new version in staging
      2. Update docker-compose.yml with exact version
      3. Commit to git before applying
      4. Apply to production
  - [ ] **Best Practice 2: Update Order**
    - [ ] Infrastructure first (databases, cache, storage)
    - [ ] Order: PostgreSQL → MongoDB → Redis → SeaweedFS → Caddy → Applications
    - [ ] Rationale: Applications depend on infrastructure being compatible
  - [ ] **Best Practice 3: Backup Before Every Update**
    - [ ] Reference pre-update backup checklist (docs/06-manutencao.md section 2.2 step 3)
    - [ ] Minimum backup: Service's database + configuration files
    - [ ] Recommended: Full system backup for major updates
  - [ ] **Best Practice 4: Test in Staging First**
    - [ ] For minor/major updates, test in non-production environment
    - [ ] Staging setup: Clone production with `docker compose -f docker-compose.yml -f docker-compose.staging.yml up -d`
    - [ ] Test checklist:
      - [ ] Service starts successfully
      - [ ] Health checks pass
      - [ ] Login works
      - [ ] Key workflows execute successfully
      - [ ] Integrations between services work
  - [ ] **Best Practice 5: Maintenance Window for Major Updates**
    - [ ] Major version updates (e.g., n8n 1.x → 2.x) require downtime
    - [ ] Schedule during low-traffic period (e.g., Sunday 2 AM - 4 AM)
    - [ ] Notify users in advance (24-48 hours)
    - [ ] Prepare rollback plan before starting
  - [ ] **Best Practice 6: Read Changelogs Thoroughly**
    - [ ] Always read changelog before updating
    - [ ] Search for keywords: "BREAKING", "MIGRATION", "DEPRECATED", "SECURITY"
    - [ ] Estimate impact on existing workflows and integrations
    - [ ] Plan configuration changes needed

- [ ] **Task 5: Create Update Checklist Template** (AC: 1, 3, 4)
  - [ ] Add new section: "2.7. Template de Checklist de Atualização"
  - [ ] **Pre-Update Checklist:**
    ```markdown
    ## Checklist de Pré-Atualização

    **Informações da Atualização:**
    - [ ] Serviço: _________________
    - [ ] Versão Atual: _________________
    - [ ] Versão Nova: _________________
    - [ ] Tipo de Update: [ ] Patch [ ] Minor [ ] Major
    - [ ] Data/Hora Planejada: _________________
    - [ ] Responsável: _________________

    **Preparação:**
    - [ ] Changelog revisado e breaking changes identificados
    - [ ] Janela de manutenção agendada (se major update)
    - [ ] Usuários notificados (se downtime esperado)
    - [ ] Backup completo realizado e verificado
    - [ ] Snapshot do servidor criado (se VPS suporta)
    - [ ] Rollback plan documentado
    - [ ] Versão anterior anotada para rollback

    **Validação de Ambiente:**
    - [ ] Espaço em disco suficiente: `df -h` (mínimo 20% livre)
    - [ ] Memória disponível: `free -h` (mínimo 4GB livre)
    - [ ] Todos containers healthy: `docker compose ps`
    - [ ] Backups recentes existem: `ls -lh /backups/`
    ```
  - [ ] **During-Update Checklist:**
    ```markdown
    ## Checklist Durante Atualização

    - [ ] Backup automático executado pelo script
    - [ ] docker-compose.yml atualizado com nova versão
    - [ ] Nova imagem baixada: `docker compose pull SERVICE`
    - [ ] Container recriado: `docker compose up -d --force-recreate SERVICE`
    - [ ] Logs monitorados: `docker compose logs -f SERVICE`
    - [ ] Startup bem-sucedido (sem erros críticos nos logs)
    - [ ] Health check passou: `docker compose ps SERVICE`
    - [ ] Tempo de startup: _________ (para comparação futura)
    ```
  - [ ] **Post-Update Checklist:**
    ```markdown
    ## Checklist Pós-Atualização

    **Validação Técnica:**
    - [ ] Container no estado "Up" e "healthy"
    - [ ] Sem erros críticos nos logs (últimos 5 minutos)
    - [ ] Conectividade com bancos de dados: `./scripts/test-connections.sh`
    - [ ] API health endpoints respondem:
      - [ ] n8n: `curl https://n8n.example.com.br/healthz`
      - [ ] Chatwoot: `curl https://chatwoot.example.com.br/health`
      - [ ] Directus: `curl https://directus.example.com.br/server/health`
    - [ ] Portas corretas expostas: `docker compose ps`
    - [ ] Volumes persistidos corretamente: `docker volume ls | grep borgstack`

    **Validação Funcional:**
    - [ ] Acesso via browser funciona
    - [ ] Login com credenciais admin funciona
    - [ ] Funcionalidade básica testada (ex: criar workflow, enviar mensagem)
    - [ ] Integrações entre serviços funcionando (ex: n8n → PostgreSQL)
    - [ ] Webhooks recebendo eventos (se aplicável)

    **Documentação:**
    - [ ] Atualização registrada em changelog
    - [ ] Versão nova anotada em documentação
    - [ ] Problemas encontrados documentados
    - [ ] Tempo total de atualização: _________ minutos

    **Rollback (se necessário):**
    - [ ] Motivo do rollback: _________________
    - [ ] Rollback executado com sucesso: [ ] Sim [ ] Não
    - [ ] Sistema restaurado ao estado anterior: [ ] Sim [ ] Não
    - [ ] Issue reportado ao desenvolvedor do serviço: [ ] Sim [ ] Não [ ] N/A
    ```

- [ ] **Task 6: Document Service-Specific Update Notes** (AC: 1, 5)
  - [ ] Add new section: "2.8. Notas Específicas por Serviço"
  - [ ] **PostgreSQL:**
    - [ ] Major version updates (e.g., 17 → 18) require `pg_upgrade` or dump/restore
    - [ ] Extensions (pgvector) must be compatible with new version
    - [ ] Always test migrations in staging due to schema changes
    - [ ] Downtime expected: 5-15 minutes for dump/restore
  - [ ] **n8n:**
    - [ ] Workflow encryption key must remain consistent (N8N_ENCRYPTION_KEY)
    - [ ] Database migrations run automatically on startup
    - [ ] Custom nodes may break on major updates
    - [ ] Webhook URLs remain stable across versions
  - [ ] **Chatwoot:**
    - [ ] Rails migrations can take 5-10 minutes on large databases
    - [ ] Redis cache should be cleared after major updates: `docker compose exec redis redis-cli FLUSHALL`
    - [ ] Agent sessions may be invalidated (users need to re-login)
  - [ ] **Evolution API:**
    - [ ] WhatsApp sessions persist across updates (no QR re-scan needed)
    - [ ] Webhook format may change between versions (check changelog)
    - [ ] Multi-instance configurations require all instances updated together
  - [ ] **Directus:**
    - [ ] Database migrations handled via `npx directus database migrate:latest`
    - [ ] Custom extensions may need updates
    - [ ] Assets/uploads persist in SeaweedFS (no re-upload needed)
  - [ ] **MongoDB:**
    - [ ] Feature compatibility version (FCV) must be updated after major upgrade
    - [ ] Command: `db.adminCommand({ setFeatureCompatibilityVersion: "7.0" })`
    - [ ] Replication set upgrades require rolling update (not applicable in single-node BorgStack)
  - [ ] **Redis:**
    - [ ] In-memory data lost on container recreation (by design)
    - [ ] RDB/AOF persistence enabled in config for critical cache
    - [ ] No migrations needed, update is instant
  - [ ] **Caddy:**
    - [ ] SSL certificates persist across updates
    - [ ] Caddyfile syntax may change (validate with `caddy validate`)
    - [ ] Automatic reloads on config changes (no restart needed if using `caddy reload`)
  - [ ] **SeaweedFS:**
    - [ ] Filer metadata stored in LevelDB (check compatibility)
    - [ ] Volume topology changes require careful planning
    - [ ] S3 API compatibility mostly stable
  - [ ] **Lowcoder:**
    - [ ] Multi-container service (update all 3 containers together)
    - [ ] MongoDB schema migrations may occur
    - [ ] Application metadata persists in MongoDB
  - [ ] **FileFlows:**
    - [ ] Flow configurations stored in volume (persist across updates)
    - [ ] FFmpeg version may change (affects codec availability)
    - [ ] Re-process failed jobs after update if codec issues
  - [ ] **Duplicati:**
    - [ ] Backup configurations stored in database (persist)
    - [ ] Schedule continues after update
    - [ ] Test backup/restore after major version update

- [ ] **Task 7: Create Quick Reference Guide** (AC: 1, 2, 3, 4, 6)
  - [ ] Add new section: "2.9. Referência Rápida de Comandos"
  - [ ] **Check for Updates:**
    ```bash
    # Check which services have updates available
    ./scripts/check-updates.sh

    # Or manually
    docker compose pull --dry-run 2>&1 | grep "Pulling"
    ```
  - [ ] **Update Single Service (Automated):**
    ```bash
    # Using update script (recommended)
    ./scripts/update-service.sh n8n 1.113.0

    # Or specify "latest"
    ./scripts/update-service.sh n8n latest
    ```
  - [ ] **Update Single Service (Manual):**
    ```bash
    # 1. Backup
    docker compose exec postgresql pg_dump -U postgres n8n_db > /backups/n8n_db_$(date +%Y%m%d).sql

    # 2. Edit docker-compose.yml (change version)
    nano docker-compose.yml

    # 3. Pull and recreate
    docker compose pull n8n
    docker compose up -d --force-recreate n8n

    # 4. Monitor
    docker compose logs -f n8n
    ```
  - [ ] **Update All Services:**
    ```bash
    # 1. Full backup
    ./scripts/backup-now.sh

    # 2. Pull all new images
    docker compose pull

    # 3. Recreate all containers
    docker compose up -d --force-recreate

    # 4. Monitor
    docker compose logs -f
    ```
  - [ ] **Rollback Service:**
    ```bash
    # 1. Stop service
    docker compose stop n8n

    # 2. Edit docker-compose.yml (revert version)
    nano docker-compose.yml

    # 3. Restore database if needed
    docker compose exec -T postgresql psql -U postgres n8n_db < /backups/n8n_db_20251007.sql

    # 4. Recreate container
    docker compose up -d --force-recreate n8n
    ```
  - [ ] **Check Service Version:**
    ```bash
    # Current versions
    docker compose images

    # Or specific service
    docker inspect $(docker compose ps -q n8n) | grep -i version
    ```
  - [ ] **View Update History:**
    ```bash
    # View update log
    tail -100 /var/log/borgstack-updates.log

    # Or filter by service
    grep "n8n" /var/log/borgstack-updates.log
    ```

- [ ] **Task 8: Update Project Documentation Cross-References** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Update docs/README.md documentation hub:
    - [ ] Ensure section "6. Manutenção" links to updated docs/06-manutencao.md
    - [ ] Add note about new update procedures in sections 2.4-2.9
  - [ ] Update docs/architecture/coding-standards.md:
    - [ ] Add cross-reference to docs/06-manutencao.md section 2.6 (update best practices)
    - [ ] Emphasize version pinning is documented both in architecture and maintenance docs
  - [ ] Update main README.md:
    - [ ] Add "Updating Components" section linking to docs/06-manutencao.md#2-atualizações-de-serviços
    - [ ] Include quick example: `./scripts/update-service.sh SERVICE VERSION`

## Dev Notes

### Previous Story Insights

**From Story 6.3 (User Guides and Tutorials):**
[Source: docs/stories/6.3.user-guides-tutorials.story.md]

- **Portuguese Documentation Quality Standard:** Story 6.3 maintained excellent Brazilian Portuguese quality from Story 6.2. Story 6.4 must maintain same natural language standard.
- **Diátaxis Framework Compliance:** Story 6.3 properly implemented How-to Guide structure for workflow templates. Story 6.4 update procedures are also How-to Guides (problem-oriented, goal-focused).
- **Code Examples Must Be Tested:** Story 6.3 included copy-pasteable bash commands. Story 6.4 must ensure all bash scripts and commands are tested and functional.
- **Cross-Reference Integration:** Story 6.3 successfully integrated new docs into docs/README.md hub. Story 6.4 must similarly integrate update procedure references.

**From Story 6.2 (Portuguese Documentation):**
[Source: docs/stories/6.2.portuguese-documentation.story.md]

- **Existing Maintenance Guide:** Story 6.2 created docs/06-manutencao.md (868 lines) with comprehensive backup strategy, daily/weekly/monthly checklists, and credential rotation procedures.
- **Update Procedures Already Exist:** Section 2.2 (Procedimento de Atualização Segura) covers 7-step update process including backup, changelog review, image pull, application, and rollback.
- **Gap Analysis for Story 6.4:**
  - ✅ AC1 (Individual update process): PARTIAL - exists in section 2.3 but needs expansion and automation script
  - ✅ AC2 (Version pinning): COMPLETE - documented in coding-standards.md
  - ✅ AC3 (Rollback procedure): COMPLETE - section 2.2 step 8
  - ✅ AC4 (Pre-update backup checklist): COMPLETE - section 2.2 step 3
  - ❌ AC5 (Common update issues): MISSING - needs dedicated troubleshooting section
  - ❌ AC6 (Update notification): MISSING - needs strategy for checking and being notified about updates

### Architecture Context

**Update Strategy Philosophy:**
[Source: docs/06-manutencao.md#2.1]

- **Conservative Approach:** BorgStack uses conservative update strategy with testing before production
- **Update Types:**
  - Patch (1.0.0 → 1.0.1): Bug fixes, no breaking changes - fast track
  - Minor (1.0.0 → 1.1.0): New features, backward compatible - tested track
  - Major (1.0.0 → 2.0.0): Breaking changes - planned track with maintenance window
- **Update Workflow:**
  1. Check for updates availability
  2. Review changelogs for breaking changes
  3. Backup (databases, volumes, configs)
  4. Pull new images
  5. Apply updates
  6. Verify health
  7. Test functionality
  8. Rollback if failure

**Version Pinning Requirements:**
[Source: docs/architecture/coding-standards.md]

- **Critical Rule:** Always specify exact image versions in docker-compose.yml. Never use `latest` tag.
- **Rationale:** Ensures reproducible deployments; prevents unexpected breaking changes
- **Example:**
  ```yaml
  # ✅ Correct
  image: n8nio/n8n:1.112.6

  # ❌ Wrong
  image: n8nio/n8n:latest
  ```
- **Version Update Workflow:**
  1. Test new version in staging
  2. Update docker-compose.yml with exact version
  3. Commit to git before applying
  4. Apply to production

**Service Dependencies and Update Order:**
[Source: docs/architecture/tech-stack.md, docs/architecture/components.md]

- **Infrastructure Layer (update first):**
  1. PostgreSQL 18.0 (shared by n8n, Chatwoot, Directus, Evolution API)
  2. MongoDB 7.0 (used by Lowcoder)
  3. Redis 8.2 (shared cache/queue for all services)
  4. SeaweedFS 3.97 (object storage for Directus, FileFlows)
  5. Caddy 2.10 (reverse proxy for all services)
- **Application Layer (update after infrastructure):**
  6. n8n 1.112.6 (depends on: PostgreSQL, Redis)
  7. Evolution API v2.2.3 (depends on: PostgreSQL, Redis)
  8. Chatwoot v4.6.0-ce (depends on: PostgreSQL, Redis)
  9. Lowcoder 2.7.4 (depends on: MongoDB, Redis)
  10. Directus 11 (depends on: PostgreSQL, Redis, SeaweedFS)
  11. FileFlows 25.09 (depends on: SeaweedFS)
  12. Duplicati 2.1.1.102 (depends on: SeaweedFS or external storage)
- **Rationale:** Applications depend on stable infrastructure. Update infrastructure first to avoid cascading failures.

**Existing Update Documentation:**
[Source: docs/06-manutencao.md sections 2.1, 2.2, 2.3]

**Section 2.1 - Update Strategy:**
- Documents conservative approach with update type classification
- Includes Mermaid flowchart showing decision tree (Patch → Quick, Minor → Tested, Major → Planned)

**Section 2.2 - Safe Update Procedure (7 steps):**
1. Check for available updates: `docker compose pull --dry-run`
2. Review changelogs (links to GitHub releases for each service)
3. Full backup (databases, volumes, configs)
4. Pull new images: `docker compose pull`
5. Apply updates: `docker compose up -d --force-recreate`
6. Verify health: `docker compose ps`, curl health endpoints
7. Functional tests (manual checklist)
8. Rollback procedure (if failure): `docker compose down`, edit docker-compose.yml, restore database, `docker compose up -d`

**Section 2.3 - Individual Service Update:**
- Brief 4-step manual procedure for updating single service
- Covers: backup, edit docker-compose.yml, pull, recreate
- Example given for updating n8n

**Gaps Identified:**
- No automated script for single service updates (scripts/update-service.sh doesn't exist)
- No troubleshooting section for common update failures
- No update notification strategy (manual check only)
- No service-specific update notes (migrations, breaking changes, etc.)

**File Paths and Project Structure:**
[Source: docs/architecture/unified-project-structure.md]

- Scripts location: `scripts/update-service.sh` (to be created)
- Existing scripts:
  - `scripts/bootstrap.sh` - Ubuntu 24.04 automated setup
  - `scripts/backup-now.sh` - Manual backup trigger
  - `scripts/restore.sh` - Disaster recovery
  - `scripts/check-storage-capacity.sh` - Storage monitoring
- Maintenance doc: `docs/06-manutencao.md` (to be enhanced)
- Coding standards: `docs/architecture/coding-standards.md` (version pinning already documented)
- Update log location: `/var/log/borgstack-updates.log` (to be created by update script)

**Script Development Standards:**
[Source: docs/architecture/coding-standards.md]

- **File naming:** kebab-case.sh (e.g., `update-service.sh`, `check-updates.sh`)
- **Shebang:** `#!/bin/bash` (Bash 5.x, Ubuntu 24.04 default)
- **Error handling:** Use `set -euo pipefail` for strict error handling
- **Logging:** All operations should log to `/var/log/borgstack-*.log`
- **Permissions:** Executable scripts: `chmod +x scripts/*.sh`
- **Comments:** Explain complex logic, include usage examples in header
- **Backup before changes:** Always create backup before destructive operations
- **User confirmation:** Prompt for confirmation before critical actions

**Docker Compose Commands Reference:**
[Source: docs/architecture/development-workflow.md]

- Check current versions: `docker compose images`
- Pull updates (dry-run): `docker compose pull --dry-run`
- Pull new images: `docker compose pull`
- Recreate single service: `docker compose up -d --force-recreate SERVICE`
- Monitor logs: `docker compose logs -f SERVICE`
- Check health: `docker compose ps`
- Stop service: `docker compose stop SERVICE`
- Restart service: `docker compose restart SERVICE`

**Health Check Patterns:**
[Source: docs/architecture/coding-standards.md, docker-compose.yml examples]

- All services must define health checks in docker-compose.yml
- Health check format:
  ```yaml
  healthcheck:
    test: ["CMD-SHELL", "command-to-test-health"]
    interval: 10s
    timeout: 5s
    retries: 5
  ```
- Common health check commands:
  - PostgreSQL: `pg_isready -U postgres`
  - Redis: `redis-cli ping`
  - HTTP services: `curl -f http://localhost:PORT/health` or `wget -q --spider http://localhost:PORT/healthz`

**Backup Requirements Before Updates:**
[Source: docs/06-manutencao.md section 2.2 step 3, docs/architecture/deployment-architecture.md]

- **Minimum backup (for patch/minor updates):**
  - Service's database dump (PostgreSQL or MongoDB)
  - Configuration files (.env, config/SERVICE/)
- **Full backup (for major updates):**
  - All databases: `pg_dumpall`, `mongodump`
  - All volumes: `tar -czf volumes.tar.gz /var/lib/docker/volumes/borgstack_*`
  - All configs: `tar -czf configs.tar.gz docker-compose.yml .env config/`
- **Verification:**
  - Test restore monthly (docs/06-manutencao.md section 3.3)
  - Ensure backups are not corrupted before proceeding with update

**Common Update Failure Scenarios:**
[Source: Development experience, architectural knowledge]

These are the scenarios to document in troubleshooting section (Task 2):

1. **Health Check Failure:**
   - Cause: Service fails to start after update due to migration, config change, or dependency issue
   - Detection: Container status shows "unhealthy" or restart loop
   - Diagnosis: `docker compose logs SERVICE --tail=100`
   - Common solutions: Wait longer (migrations), check env vars, check DB connectivity, rollback

2. **Database Migration Failure:**
   - Cause: Database schema migration fails during service startup
   - Detection: Logs show migration error, container exits
   - Diagnosis: `docker compose logs SERVICE | grep -i migration`
   - Common solutions: Check disk space, check DB permissions, restore backup and retry, consult changelog

3. **Breaking Changes in API:**
   - Cause: Service API changes format, breaking existing integrations
   - Detection: Webhooks fail, n8n workflows break, external integrations stop working
   - Diagnosis: Review changelog for "BREAKING CHANGE"
   - Common solutions: Update n8n workflows, update webhook formats, adjust configurations per docs

4. **Version Incompatibility:**
   - Cause: Service requires newer version of dependency (e.g., PostgreSQL, Redis)
   - Detection: Service fails to start, logs show version mismatch error
   - Diagnosis: Check dependency versions, review compatibility matrix in changelog
   - Common solutions: Update dependencies first, rollback to compatible version

5. **Lost Configuration:**
   - Cause: Volume removed accidentally, path changed in docker-compose.yml
   - Detection: Service starts with default config, credentials don't work
   - Diagnosis: `docker volume ls | grep borgstack`
   - Common solutions: Restore config from backup, check volume paths

6. **Image Not Found:**
   - Cause: Version typo, deprecated tag, Docker Hub issue
   - Detection: `docker compose pull` fails with "manifest unknown"
   - Diagnosis: Check Docker Hub for available tags
   - Common solutions: Fix version typo (1.63.0 vs v1.63.0), use different tag

**Update Notification Strategy Requirements:**
[Source: AC6, operational best practices]

Story 6.4 must document:

1. **Manual Check Method:**
   - Command: `docker compose pull --dry-run 2>&1 | grep "Pulling"`
   - Frequency: Weekly (integrate with weekly-check.sh)

2. **Automated Check Script:**
   - Script: `scripts/check-updates.sh`
   - Logic: Query Docker Hub API for each service, compare current vs. latest
   - Output: Table showing SERVICE | CURRENT | LATEST | UPDATE_TYPE
   - Schedule: Weekly via cron (Monday mornings)

3. **Changelog Monitoring:**
   - GitHub Releases RSS feeds
   - "Watch" repositories with "Releases only" notifications
   - Security mailing lists (PostgreSQL, Redis, Docker)

4. **Email Notifications:**
   - Send email if critical security updates available
   - Include changelog links and update priority

### Testing Strategy

**Documentation Testing Approach:**
[Source: docs/architecture/testing-strategy.md, Story 6.3 testing precedent]

**No Unit Tests Required:**
- Documentation is not code
- Scripts should be tested manually
- Focus on manual validation and command verification

**Testing Checklist for Story 6.4:**

1. **Script Testing:**
   - Create `scripts/update-service.sh` and test on real service (n8n recommended)
   - Create `scripts/check-updates.sh` and verify output accuracy
   - Test rollback procedure in update-service.sh
   - Verify logging to `/var/log/borgstack-updates.log`
   - Test error handling (invalid service name, network failure, health check failure)

2. **Documentation Accuracy:**
   - Verify all bash commands are correct and tested
   - Test update procedure steps manually on staging environment
   - Verify troubleshooting solutions work for documented issues
   - Test rollback procedure on at least one service

3. **Completeness:**
   - Verify each AC covered by documentation and/or scripts
   - Check for gaps in update workflow coverage
   - Ensure all 12 services have service-specific notes

4. **Cross-Reference Integrity:**
   - Verify links between docs/06-manutencao.md and docs/architecture/coding-standards.md
   - Check docs/README.md navigation includes update procedures
   - Test all changelog URLs for each service

**Validation Commands:**
```bash
# Test update-service.sh script
./scripts/update-service.sh --help
./scripts/update-service.sh n8n 1.112.6  # Should work (current version)

# Test check-updates.sh script
./scripts/check-updates.sh

# Verify documentation sections exist
grep -n "2.4. Solução de Problemas" docs/06-manutencao.md
grep -n "2.5. Estratégia de Notificação" docs/06-manutencao.md
grep -n "2.6. Boas Práticas" docs/06-manutencao.md
grep -n "2.7. Template de Checklist" docs/06-manutencao.md
grep -n "2.8. Notas Específicas" docs/06-manutencao.md
grep -n "2.9. Referência Rápida" docs/06-manutencao.md

# Test manual update procedure (on staging)
# 1. Backup
docker compose exec postgresql pg_dump -U postgres n8n_db > /tmp/test_backup.sql

# 2. Update docker-compose.yml (same version for safety)
# 3. Pull and recreate
docker compose pull n8n
docker compose up -d --force-recreate n8n

# 4. Monitor
docker compose logs -f n8n

# 5. Verify health
docker compose ps n8n
curl -f https://n8n.example.com.br/healthz
```

**Expected Deliverables:**
- 2 new scripts: `update-service.sh`, `check-updates.sh`
- 6 new sections in docs/06-manutencao.md (2.4, 2.5, 2.6, 2.7, 2.8, 2.9)
- Updated cross-references in docs/README.md, docs/architecture/coding-standards.md, README.md
- Estimated new content: 1,200-1,800 lines (scripts + documentation enhancements)

### Project Structure Alignment

**No Conflicts Detected:**

All new file paths align with defined project structure:
[Source: docs/architecture/unified-project-structure.md]

- Scripts: `scripts/update-service.sh`, `scripts/check-updates.sh` (aligned with scripts/ directory)
- Documentation: `docs/06-manutencao.md` (existing file to be enhanced)
- Log files: `/var/log/borgstack-updates.log` (standard Linux log location)

**Cross-References Required:**
- docs/06-manutencao.md should reference docs/architecture/coding-standards.md (version pinning)
- docs/architecture/coding-standards.md should reference docs/06-manutencao.md section 2.6 (update best practices)
- docs/README.md should link to new update procedure sections
- Main README.md should link to update documentation

## Testing

### Test Requirements

**Script Testing:**
[Source: docs/architecture/testing-strategy.md]

**No Automated Tests Required:**
- Scripts are operational tools, not application code
- Manual testing in staging environment is sufficient
- Focus on validation that scripts work as documented

**Script Testing Approach:**

1. **update-service.sh Testing:**
   - Test with valid service name and version
   - Test with invalid service name (should error gracefully)
   - Test with invalid version (should error gracefully)
   - Test health check failure scenario (simulate by stopping dependent service)
   - Test rollback functionality
   - Verify logging to /var/log/borgstack-updates.log
   - Verify backup is created before update
   - Estimated time: 30-45 minutes

2. **check-updates.sh Testing:**
   - Test Docker Hub API connectivity
   - Verify version comparison logic (current vs. latest)
   - Test output format (table with SERVICE | CURRENT | LATEST | TYPE)
   - Test email notification (if implemented)
   - Estimated time: 15-20 minutes

**Documentation Testing:**

1. **Command Accuracy:**
   - Execute every bash command in documentation to verify correctness
   - Test on Ubuntu 24.04 LTS environment
   - Verify expected outputs match documented outputs

2. **Procedure Validation:**
   - Follow complete update procedure from docs/06-manutencao.md section 2.2 on staging
   - Test rollback procedure (section 2.2 step 8)
   - Verify troubleshooting solutions (section 2.4) resolve documented issues

3. **Cross-Reference Testing:**
   - Verify all internal links work (markdown-link-check)
   - Test navigation from docs/README.md to update sections
   - Verify changelog URLs for all 12 services are valid

**Validation Checklist:**
```bash
# 1. Test update-service.sh exists and is executable
test -x scripts/update-service.sh && echo "✓ update-service.sh exists and executable"

# 2. Test check-updates.sh exists and is executable
test -x scripts/check-updates.sh && echo "✓ check-updates.sh exists and executable"

# 3. Verify new sections in docs/06-manutencao.md
grep -q "2.4. Solução de Problemas em Atualizações" docs/06-manutencao.md && echo "✓ Section 2.4 exists"
grep -q "2.5. Estratégia de Notificação de Atualizações" docs/06-manutencao.md && echo "✓ Section 2.5 exists"
grep -q "2.6. Boas Práticas de Atualização" docs/06-manutencao.md && echo "✓ Section 2.6 exists"
grep -q "2.7. Template de Checklist de Atualização" docs/06-manutencao.md && echo "✓ Section 2.7 exists"
grep -q "2.8. Notas Específicas por Serviço" docs/06-manutencao.md && echo "✓ Section 2.8 exists"
grep -q "2.9. Referência Rápida de Comandos" docs/06-manutencao.md && echo "✓ Section 2.9 exists"

# 4. Test update script with current version (safe test)
./scripts/update-service.sh n8n $(docker compose images n8n | grep n8n | awk '{print $2}')

# 5. Test check-updates script
./scripts/check-updates.sh

# 6. Verify log file created
test -f /var/log/borgstack-updates.log && echo "✓ Update log file exists"

# 7. Count new documentation lines
wc -l docs/06-manutencao.md

# 8. Test rollback procedure (simulate update failure)
echo "Testing rollback functionality with simulated update failure..."
# Save current version
CURRENT_VERSION=$(docker compose images n8n | grep n8n | awk '{print $2}')
# Try to update to non-existent version (should trigger rollback prompt)
./scripts/update-service.sh n8n 999.999.999
# Verify n8n still on original version after rollback
docker compose images n8n | grep n8n | grep "$CURRENT_VERSION" && echo "✓ Rollback successful"
```

**Expected Test Results:**
- All scripts execute without errors
- Scripts handle invalid inputs gracefully (error messages, non-zero exit codes)
- Backup is created before any changes
- Health checks detect failed services
- Rollback restores previous version successfully
- Documentation commands execute correctly
- Cross-references navigate correctly

**Performance Expectations:**
- update-service.sh execution time: 2-5 minutes (depends on image size)
- check-updates.sh execution time: < 30 seconds (API calls for 12 services)
- Rollback execution time: 2-3 minutes (restore + recreate)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-08 | 1.1 | Applied should-fix corrections from validation: Docker Hub API auth, multi-container handling, rollback testing, corrected service count (12 not 14) | Sarah (Product Owner) |
| 2025-10-08 | 1.2 | Approved for implementation - Validation complete (8.5/10 readiness score) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

## QA Results
TBD
