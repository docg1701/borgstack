# Chatwoot Customer Service Platform - Setup Guide

This document provides complete setup instructions for Chatwoot v4.6.0-ce customer service platform integration with BorgStack.

---

## Table of Contents

1. [First-Time Admin Account Creation](#first-time-admin-account-creation)
2. [API Token Generation (REQUIRED for n8n Integration)](#api-token-generation-required-for-n8n-integration)
3. [Agent User Management and Permissions](#agent-user-management-and-permissions)
4. [WhatsApp Channel Integration via Evolution API + n8n](#whatsapp-channel-integration-via-evolution-api--n8n)
5. [Future Social Media Channel Integrations](#future-social-media-channel-integrations)
6. [Troubleshooting Guide](#troubleshooting-guide)

---

## First-Time Admin Account Creation

### Initial Deployment

1. **Deploy Chatwoot container:**
   ```bash
   docker compose up -d chatwoot
   ```

2. **Monitor startup progress:**
   ```bash
   docker compose logs -f chatwoot
   ```

   Wait for these messages (startup takes ~90 seconds):
   - `Database migration completed` (Rails ActiveRecord migrations)
   - `Webpacker compilation finished` (JavaScript/CSS asset compilation)
   - `Puma starting in production mode` (Web server ready)
   - `Sidekiq starting` (Background job processor ready)

3. **Access Chatwoot web UI:**
   - URL: `https://chatwoot.${DOMAIN}/app`
   - First visit will show account creation form

4. **Create admin account:**
   - **Full Name:** Your name (e.g., "João Silva")
   - **Email:** Your admin email (this becomes your login username)
   - **Password:** Strong password (minimum 8 characters, use password manager)
   - **Account Name:** Your organization name (e.g., "BorgStack Support")

   Click **"Create Account"** to complete setup.

5. **Verify successful login:**
   - Dashboard should load with empty conversation list
   - Left sidebar shows: Conversations, Contacts, Reports, Settings
   - Top right shows your profile avatar

---

## API Token Generation (REQUIRED for n8n Integration)

### ⚠️ CRITICAL - Manual Step Required

The `CHATWOOT_API_TOKEN` **CANNOT** be auto-generated by the bootstrap script. This token is required for n8n workflows to access the Chatwoot API.

### Step-by-Step Token Generation

1. **Login to Chatwoot:**
   - URL: `https://chatwoot.${DOMAIN}/app`
   - Use admin email and password from First-Time Setup

2. **Navigate to Account Settings:**
   - Click **profile avatar** (top right corner)
   - Select **"Profile Settings"** from dropdown menu
   - Click **"Access Tokens"** tab in left sidebar

3. **Create New API Token:**
   - Click **"Add New Token"** button
   - **Token Name:** `n8n Integration` (descriptive name for reference)
   - Click **"Create"** button

4. **Copy Token (IMPORTANT - Only Shown Once):**
   - Token will be displayed in green banner: `Token created successfully`
   - **Copy token immediately** - it will NOT be shown again
   - Token format: Long alphanumeric string (e.g., `AbC123XyZ...`)

5. **Add Token to .env File:**
   ```bash
   # Edit .env file
   nano .env

   # Find and update this line:
   CHATWOOT_API_TOKEN=<obtain-from-admin-ui-after-first-login>

   # Replace with your actual token:
   CHATWOOT_API_TOKEN=AbC123XyZ... (paste your actual token here)

   # Save and exit (Ctrl+X, Y, Enter)
   ```

6. **Restart Chatwoot Container:**
   ```bash
   docker compose restart chatwoot
   ```

   Verify restart successful:
   ```bash
   docker compose ps chatwoot
   # Should show: Up (healthy)
   ```

7. **Verify Token Works:**
   ```bash
   # Test API access (replace ${CHATWOOT_HOST} with your actual domain)
   curl -f https://chatwoot.${DOMAIN}/api/v1/accounts \
     -H "api_access_token: ${CHATWOOT_API_TOKEN}"

   # Should return JSON with account details (not error)
   ```

### Token Permissions

The generated token has **full access** to all Chatwoot API endpoints:
- ✅ Create/read/update conversations
- ✅ Create/read/update contacts
- ✅ Post messages to conversations
- ✅ Manage agent assignments
- ✅ Access reports and analytics

**Security Warning:** Protect this token like a password. Anyone with this token can access ALL Chatwoot data via API.

### Token Storage for n8n Workflows

When creating n8n workflows that access Chatwoot:

1. **DO NOT hardcode token in workflow** (security risk)
2. **Use n8n Credentials Manager:**
   - In n8n UI: Go to **Credentials** → **New Credential**
   - Select **"HTTP Header Auth"** credential type
   - **Name:** `Chatwoot API Token`
   - **Header Name:** `api_access_token`
   - **Header Value:** Paste your `CHATWOOT_API_TOKEN` value
   - Click **"Create"**

3. **Reference credential in HTTP Request nodes:**
   - In HTTP Request node configuration
   - **Authentication:** Select `HTTP Header Auth`
   - **Credentials:** Select `Chatwoot API Token`

---

## Agent User Management and Permissions

### Adding New Agents

1. **Navigate to Settings:**
   - Click **Settings** (gear icon in left sidebar)
   - Select **"Agents"** from Settings menu

2. **Invite New Agent:**
   - Click **"Add Agent"** button
   - **Agent Name:** Full name (e.g., "Maria Santos")
   - **Agent Email:** Email address (becomes login username)
   - **Agent Role:** Select role (see roles below)
   - Click **"Add Agent"**

3. **Agent Activation:**
   - Agent receives invitation email with setup link
   - Agent clicks link, sets password, activates account
   - Agent can now login and access conversations

### Agent Roles and Permissions

| Role | Permissions | Use Case |
|------|------------|----------|
| **Administrator** | Full access: all conversations, settings, reports, agent management | Team leads, managers |
| **Agent** | Access assigned conversations, cannot change settings | Front-line support staff |

### Managing Agent Availability

1. **Agent Status Settings:**
   - Each agent can set their status: **Online** / **Busy** / **Offline**
   - Status affects auto-assignment logic
   - Offline agents do not receive new auto-assigned conversations

2. **Working Hours (Optional):**
   - Settings → Account Settings → Business Hours
   - Define working hours per day
   - Auto-responder for off-hours messages

### Conversation Assignment

**Manual Assignment:**
- Open conversation → Click **"Assign Agent"** dropdown → Select agent

**Auto-Assignment:**
- Settings → Inboxes → Select Inbox → Enable **"Auto Assignment"**
- New conversations automatically assigned to online agents (round-robin)

---

## WhatsApp Channel Integration via Evolution API + n8n

Chatwoot integrates with WhatsApp using **Evolution API** (WhatsApp Business gateway) and **n8n** (workflow orchestration).

### Architecture Overview

```
┌─────────────┐       ┌──────────────┐       ┌──────────┐       ┌─────────────┐
│  WhatsApp   │──────>│ Evolution    │──────>│   n8n    │──────>│  Chatwoot   │
│  Customer   │       │     API      │       │ Webhook  │       │     API     │
│             │<──────│ (Webhook)    │<──────│ Workflow │<──────│ (Webhook)   │
└─────────────┘       └──────────────┘       └──────────┘       └─────────────┘
```

**Message Flow:**
1. **Incoming:** WhatsApp → Evolution API → n8n webhook → Chatwoot API (create conversation + post message)
2. **Outgoing:** Chatwoot webhook → n8n workflow → Evolution API → WhatsApp

### Prerequisites

✅ Evolution API deployed (Story 2.2)
✅ n8n deployed (Story 2.1)
✅ `CHATWOOT_API_TOKEN` generated and added to .env (see section above)
✅ WhatsApp instance connected to Evolution API

### Step 1: Create WhatsApp Inbox in Chatwoot

1. **Navigate to Settings → Inboxes:**
   - Click **"Add Inbox"** button
   - Select **"API"** channel type (Chatwoot does not have native WhatsApp, we use API)

2. **Configure API Inbox:**
   - **Inbox Name:** `WhatsApp Support` (or your preferred name)
   - **Channel Type:** API
   - **Webhook URL:** Leave blank (we POST to Chatwoot, not receive webhooks here)
   - Click **"Create API Inbox"**

3. **Copy Inbox ID:**
   - After creation, inbox list shows new inbox
   - Note the **Inbox ID** (visible in URL or inbox settings)
   - Example: `https://chatwoot.${DOMAIN}/app/accounts/1/settings/inboxes/42`
   - Inbox ID: `42` (needed for n8n workflow)

### Step 2: Configure n8n WhatsApp → Chatwoot Workflow

See **Task 11** documentation: `config/n8n/workflows/04-whatsapp-chatwoot-integration.json`

This workflow handles:
- Receiving WhatsApp messages from Evolution API webhook
- Finding or creating Chatwoot contact (by phone number)
- Creating conversation in Chatwoot inbox
- Posting message content to conversation

### Step 3: Configure Chatwoot → WhatsApp Reply Workflow

1. **Create Chatwoot Webhook in Settings:**
   - Settings → Integrations → Webhooks → **"Add Webhook"**
   - **Webhook URL:** `https://n8n.${DOMAIN}/webhook/chatwoot-outgoing`
   - **Events to Subscribe:**
     - ✅ `message_created` (triggers on agent reply)
   - Click **"Create Webhook"**

2. **Create n8n Workflow for Outgoing Messages:**
   - Trigger: Webhook node listening on `/chatwoot-outgoing`
   - Filter: Only process `message_type: outgoing` (agent replies, not customer messages)
   - HTTP Request: POST to Evolution API `/message/sendText/{instanceName}`
   - Payload: Map Chatwoot message content to WhatsApp format

### Testing WhatsApp Integration

1. **Send Test Message:**
   - Send WhatsApp message to your Evolution API connected number
   - Message should appear in Chatwoot Conversations within 2-5 seconds

2. **Reply from Chatwoot:**
   - Open conversation in Chatwoot
   - Type reply in message box
   - Click **"Send"** or press Enter
   - Reply should be delivered to WhatsApp within 2-5 seconds

3. **Troubleshooting Test Failures:**
   - Check n8n workflow execution logs (n8n UI → Executions)
   - Check Evolution API logs: `docker compose logs evolution`
   - Check Chatwoot logs: `docker compose logs chatwoot`
   - Verify `CHATWOOT_API_TOKEN` is set in .env
   - Verify Evolution API webhook URL points to n8n: `${EVOLUTION_WEBHOOK_URL}`

---

## Future Social Media Channel Integrations

The following social media integrations are **planned for post-MVP** implementation:

### Instagram Direct Messages
- **Status:** Post-MVP (Epic 6)
- **Integration Method:** Meta Business Suite API + n8n workflow
- **Requirements:** Instagram Business Account, Facebook Page connection

### Facebook Messenger
- **Status:** Post-MVP (Epic 6)
- **Integration Method:** Meta Messenger Platform API + n8n workflow
- **Requirements:** Facebook Page, Messenger App configuration

### Telegram
- **Status:** Post-MVP (Epic 6)
- **Integration Method:** Telegram Bot API + n8n workflow
- **Requirements:** Telegram Bot Token (via @BotFather)

**Note:** Email and SMS channels are **NOT** in scope for BorgStack (handled by external providers).

---

## Troubleshooting Guide

### Problem: Cannot Access Chatwoot Web UI (HTTPS Error)

**Symptoms:**
- Browser shows SSL certificate error or connection refused
- URL: `https://chatwoot.${DOMAIN}/app`

**Solutions:**

1. **Verify DNS A Record:**
   ```bash
   dig chatwoot.${DOMAIN} +short
   # Should return: YOUR_SERVER_IP
   ```
   If empty: Create DNS A record pointing to server IP

2. **Verify Caddy is Running:**
   ```bash
   docker compose ps caddy
   # Should show: Up (healthy)
   ```
   If not running: Check Caddy logs: `docker compose logs caddy`

3. **Verify Chatwoot Container Healthy:**
   ```bash
   docker compose ps chatwoot
   # Should show: Up (healthy)
   ```
   If unhealthy: Check startup logs: `docker compose logs chatwoot | grep -i error`

4. **Verify Firewall Ports Open:**
   ```bash
   sudo ufw status
   # Should show: 80/tcp ALLOW, 443/tcp ALLOW
   ```
   If not open: Run `sudo ufw allow 80/tcp && sudo ufw allow 443/tcp`

---

### Problem: Chatwoot Container Fails to Start (Crash Loop)

**Symptoms:**
- `docker compose ps chatwoot` shows: `Restarting` or `Exited (1)`
- Health check never becomes healthy

**Solutions:**

1. **Check Rails Database Migration Errors:**
   ```bash
   docker compose logs chatwoot | grep -i "migration"
   # Look for: PG::ConnectionBad, ActiveRecord::Migration errors
   ```

   If database connection fails:
   - Verify PostgreSQL is healthy: `docker compose ps postgresql`
   - Verify `CHATWOOT_DB_PASSWORD` in .env matches database password
   - Verify chatwoot_db exists: `docker compose exec postgresql psql -U postgres -c "\l" | grep chatwoot_db`

2. **Check SECRET_KEY_BASE Configuration:**
   ```bash
   docker compose config | grep CHATWOOT_SECRET_KEY_BASE
   # Should show: 128-character hex string
   ```

   If empty or short:
   - Regenerate: `openssl rand -hex 64`
   - Update .env file: `CHATWOOT_SECRET_KEY_BASE=<new-key-here>`
   - Restart: `docker compose restart chatwoot`

3. **Check Redis Connection:**
   ```bash
   docker compose logs chatwoot | grep -i redis
   # Look for: Redis::CannotConnectError
   ```

   If Redis connection fails:
   - Verify Redis is healthy: `docker compose ps redis`
   - Verify `REDIS_PASSWORD` in .env is correct

4. **Increase Memory Allocation (if low RAM):**
   Rails + Webpacker compilation requires significant memory during startup.
   - Check server RAM: `free -h`
   - If < 16GB: Consider increasing swap or server RAM

---

### Problem: WhatsApp Messages Not Appearing in Chatwoot

**Symptoms:**
- WhatsApp messages sent but not visible in Chatwoot Conversations

**Solutions:**

1. **Verify n8n Workflow Execution:**
   - Open n8n UI: `https://n8n.${DOMAIN}`
   - Go to **Executions** tab
   - Check for recent execution of "04 - WhatsApp Chatwoot Integration" workflow
   - If execution failed: Click to view error details

2. **Verify Evolution API Webhook Configuration:**
   ```bash
   docker compose config | grep EVOLUTION_WEBHOOK_URL
   # Should show: https://n8n.${DOMAIN}/webhook/whatsapp-incoming
   ```

   Verify webhook is active:
   - Open Evolution API Admin UI: `https://evolution.${DOMAIN}/manager`
   - Check webhook configuration for your instance

3. **Verify CHATWOOT_API_TOKEN is Set:**
   ```bash
   grep CHATWOOT_API_TOKEN .env
   # Should show: CHATWOOT_API_TOKEN=<long-alphanumeric-token>
   # Should NOT show: <obtain-from-admin-ui-after-first-login>
   ```

   If token not set: Follow **API Token Generation** section above

4. **Test Chatwoot API Manually:**
   ```bash
   # Test creating a conversation via API
   curl -X POST https://chatwoot.${DOMAIN}/api/v1/accounts/1/conversations \
     -H "api_access_token: ${CHATWOOT_API_TOKEN}" \
     -H "Content-Type: application/json" \
     -d '{
       "source_id": "test-contact-123",
       "inbox_id": 1,
       "contact_id": 1
     }'

   # Should return: JSON with conversation details (201 Created)
   # If error: Check token validity and API endpoint
   ```

---

### Problem: Agent Replies Not Sent to WhatsApp

**Symptoms:**
- Agent types reply in Chatwoot and clicks Send
- Reply appears in Chatwoot conversation but not delivered to WhatsApp

**Solutions:**

1. **Verify Chatwoot → n8n Webhook Configured:**
   - Chatwoot Settings → Integrations → Webhooks
   - Should show: Webhook URL pointing to `https://n8n.${DOMAIN}/webhook/chatwoot-outgoing`
   - Events subscribed: `message_created`

2. **Verify n8n Outgoing Workflow Exists:**
   - n8n UI → Workflows
   - Look for: Workflow with webhook trigger `/chatwoot-outgoing`
   - Workflow should: Filter for `message_type: outgoing` → POST to Evolution API

3. **Check n8n Execution Logs:**
   - n8n UI → Executions
   - Filter for outgoing workflow executions
   - Check for errors in Evolution API HTTP Request node

4. **Verify Evolution API Instance is Active:**
   ```bash
   # Check instance status
   curl https://evolution.${DOMAIN}/instance/fetchInstances \
     -H "apikey: ${EVOLUTION_API_KEY}"

   # Should show: "state": "open" (connected to WhatsApp)
   # If "state": "close": Reconnect via QR code scan
   ```

---

### Problem: API Token Stopped Working (401 Unauthorized)

**Symptoms:**
- n8n workflows return `401 Unauthorized` errors
- Chatwoot API calls fail with authentication error

**Solutions:**

1. **Verify Token Still Valid:**
   - Chatwoot Profile Settings → Access Tokens
   - Check if token still listed (tokens can be revoked)

2. **Regenerate Token:**
   - Delete old token in Chatwoot UI
   - Create new token (follow **API Token Generation** section)
   - Update .env file with new token
   - Restart Chatwoot: `docker compose restart chatwoot`
   - Update n8n credentials with new token

---

## Additional Resources

- **Chatwoot Official Documentation:** https://www.chatwoot.com/docs/
- **Chatwoot API Reference:** https://www.chatwoot.com/developers/api/
- **Evolution API Documentation:** https://doc.evolution-api.com/
- **n8n Documentation:** https://docs.n8n.io/

---

**Last Updated:** Story 3.1 (Chatwoot Customer Service) - 2025-10-03
