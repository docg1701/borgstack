# Directus Headless CMS Configuration

## Overview

Directus is a headless CMS and data management platform that provides REST and GraphQL APIs for content delivery. It uses PostgreSQL for structured data storage, Redis for caching, and local file storage for media assets (with S3 migration planned for Story 5.1).

**Version:** Directus 11
**Container Name:** `directus`
**Admin UI:** https://directus.{YOUR_DOMAIN}/admin
**REST API:** https://directus.{YOUR_DOMAIN}/items/{collection}
**GraphQL API:** https://directus.{YOUR_DOMAIN}/graphql

---

## First-Time Admin Login

After deploying Directus, the admin account is automatically created on first startup using the credentials from your `.env` file.

### Steps to Access Directus

1. **Wait for Container to be Healthy**
   ```bash
   docker compose ps directus
   ```
   Wait until status shows `healthy` (may take 60-90 seconds for database migrations).

2. **Access Admin UI**
   - Navigate to: `https://directus.{YOUR_DOMAIN}/admin`
   - Login with credentials from `.env`:
     - Email: `DIRECTUS_ADMIN_EMAIL` (default: admin@{YOUR_DOMAIN})
     - Password: `DIRECTUS_ADMIN_PASSWORD` (auto-generated by bootstrap script)

3. **Find Your Credentials**
   ```bash
   grep "DIRECTUS_ADMIN" .env
   ```

---

## Creating Content Collections and Fields

Directus uses **collections** (like database tables) and **fields** (like columns) to model your content.

### Create a Collection

1. Go to **Settings → Data Model** in the Directus admin UI
2. Click **"Create Collection"**
3. Enter collection name (e.g., `blog_posts`, `products`, `team_members`)
4. Choose collection type:
   - **Standard Collection:** Regular content (default)
   - **Singleton:** Single-item collection (e.g., site settings)
5. Configure collection options:
   - Display template (how items are shown in lists)
   - Icon and color for navigation
6. Click **"Save"**

### Add Fields to Collection

1. Select your collection in **Settings → Data Model**
2. Click **"Create Field"** or the **"+"** button
3. Choose field type:
   - **Input:** Text, number, boolean, date/time
   - **Selection:** Dropdown, radio, checkboxes
   - **Relational:** Link to other collections (many-to-one, one-to-many, many-to-many)
   - **Presentation:** Divider, notice (UI-only fields)
4. Configure field settings:
   - Field name (API key)
   - Display name (admin UI label)
   - Validation rules (required, unique, regex pattern)
   - Default value
5. Click **"Save"**

### Example Collection: Blog Posts

```
Collection: blog_posts
Fields:
  - title (Input → Text, required)
  - slug (Input → Text, required, unique)
  - content (Input → WYSIWYG)
  - author (Input → Text)
  - published_date (Input → Date/Time)
  - featured_image (File → Image)
  - status (Selection → Dropdown: draft, published, archived)
```

---

## Managing Content (CRUD Operations)

### Create Content

1. Navigate to your collection in the **Content** section
2. Click **"Create Item"**
3. Fill in the fields
4. Click **"Save"**

### Read/Browse Content

1. Navigate to your collection in the **Content** section
2. Use filters, search, and sorting to find items
3. Click an item to view/edit details

### Update Content

1. Navigate to your collection and select an item
2. Modify fields as needed
3. Click **"Save"**

### Delete Content

1. Navigate to your collection and select an item
2. Click the **trash icon** or **"Delete"** button
3. Confirm deletion

---

## File Uploads and Media Management

### Upload Files

1. Navigate to **File Library** in the sidebar
2. Click **"Upload Files"** or drag-and-drop files
3. Files are stored in the `borgstack_directus_uploads` Docker volume
4. Access uploaded files via: `https://directus.{YOUR_DOMAIN}/assets/{file_id}`

### Use Files in Collections

1. Add a **File** field to your collection
2. When creating/editing an item, click the file field
3. Choose from existing files or upload new ones

### File Storage Location

**Current (Story 4.1):** Local volume storage
- Volume: `borgstack_directus_uploads`
- Path inside container: `/directus/uploads`

**Future (Story 5.1):** SeaweedFS S3-compatible storage
- Migration plan: See "Future Enhancements" section below

---

## REST API Endpoints

Directus provides a powerful REST API for programmatic access.

### Base URL
```
https://directus.{YOUR_DOMAIN}
```

### Common Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/server/health` | GET | Health check (returns 200 OK when healthy) |
| `/server/ping` | GET | Ping endpoint (returns "pong") |
| `/items/{collection}` | GET | List items in collection |
| `/items/{collection}/{id}` | GET | Get single item by ID |
| `/items/{collection}` | POST | Create new item |
| `/items/{collection}/{id}` | PATCH | Update existing item |
| `/items/{collection}/{id}` | DELETE | Delete item |
| `/assets/{file_id}` | GET | Access uploaded file |
| `/users/me` | GET | Get current user info |

### Authentication

API requests require authentication. Use one of these methods:

1. **Bearer Token** (recommended):
   ```bash
   curl -H "Authorization: Bearer YOUR_API_TOKEN" \
        https://directus.{YOUR_DOMAIN}/items/blog_posts
   ```

2. **Static Token** (generated in admin UI):
   - Go to **User Menu → Access Tokens**
   - Create new token with appropriate permissions
   - Include in Authorization header

### Example API Requests

**Get all blog posts:**
```bash
curl https://directus.{YOUR_DOMAIN}/items/blog_posts
```

**Create new blog post:**
```bash
curl -X POST https://directus.{YOUR_DOMAIN}/items/blog_posts \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title": "Hello World", "content": "My first post"}'
```

**Update blog post:**
```bash
curl -X PATCH https://directus.{YOUR_DOMAIN}/items/blog_posts/1 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"status": "published"}'
```

---

## GraphQL API

Directus provides a GraphQL API for more flexible queries.

### GraphQL Endpoint
```
https://directus.{YOUR_DOMAIN}/graphql
```

### Example GraphQL Query

**Get blog posts with filtering:**
```graphql
query {
  blog_posts(filter: { status: { _eq: "published" } }) {
    id
    title
    content
    author
    published_date
  }
}
```

**Create blog post mutation:**
```graphql
mutation {
  create_blog_posts_item(data: {
    title: "GraphQL Post"
    content: "Created via GraphQL"
    status: "draft"
  }) {
    id
    title
  }
}
```

### GraphQL Playground

Access the interactive GraphQL explorer at:
```
https://directus.{YOUR_DOMAIN}/graphql
```

---

## User and Permission Management

### Create Users

1. Go to **Settings → Access Control → Users**
2. Click **"Create User"**
3. Fill in user details:
   - Email (used for login)
   - Password
   - First name, last name
4. Assign role (defines permissions)
5. Click **"Save"**

### Manage Roles

1. Go to **Settings → Access Control → Roles**
2. Click **"Create Role"** or edit existing role
3. Configure permissions:
   - **Public:** No authentication required
   - **Administrator:** Full access to everything
   - **Custom Roles:** Granular permissions per collection

### Permission Levels

For each collection, you can set CRUD permissions:
- **Create:** Can add new items
- **Read:** Can view items
- **Update:** Can edit items
- **Delete:** Can remove items

Permissions can have conditions (e.g., "only read items where author = current user").

---

## Integrating with n8n Workflows

Directus can trigger n8n workflows on content events.

### Use Cases

- Publish blog post → Send notification via WhatsApp (Evolution API)
- Upload product image → Process with FileFlows → Update product record
- Create customer inquiry → Create ticket in Chatwoot

### Integration Methods

1. **n8n Directus Node:**
   - Available in n8n workflow editor
   - Supports CRUD operations on collections
   - Requires API token for authentication

2. **Webhooks:**
   - Configure in **Settings → Webhooks**
   - Trigger n8n workflow on content events (create, update, delete)
   - Send HTTP POST to: `https://n8n.{YOUR_DOMAIN}/webhook/directus-event`

3. **REST API Calls:**
   - Use n8n HTTP Request node
   - Call Directus REST API endpoints
   - Include Bearer token for authentication

---

## Troubleshooting

### Common Issues

#### 1. Database Migration Failures

**Symptoms:** Container starts but shows database errors in logs

**Check PostgreSQL logs:**
```bash
docker compose logs postgresql | grep -i error
```

**Verify directus_user permissions:**
```bash
docker compose exec postgresql psql -U postgres -c "\du" | grep directus_user
```

**Solution:**
- Ensure `directus_db` exists and is owned by `directus_user`
- Verify `DIRECTUS_DB_PASSWORD` matches in `.env` and PostgreSQL
- Check PostgreSQL init script: `config/postgresql/init-databases.sql`

#### 2. File Upload Storage Issues

**Symptoms:** File uploads fail or files don't appear

**Check volume mount:**
```bash
docker compose exec directus ls -la /directus/uploads
```

**Verify STORAGE_LOCATIONS:**
```bash
docker compose exec directus env | grep STORAGE_LOCATIONS
```

**Solution:**
- Ensure `STORAGE_LOCATIONS=local` is set in docker-compose.yml
- Verify `borgstack_directus_uploads` volume is mounted
- Check file permissions in container (should be writable by directus user)

#### 3. Redis Cache Not Working

**Symptoms:** Slow API responses, cache misses in logs

**Check Redis connection:**
```bash
docker compose exec redis redis-cli -a ${REDIS_PASSWORD} ping
```

**Verify Directus Redis configuration:**
```bash
docker compose exec directus env | grep REDIS
```

**Solution:**
- Verify `REDIS_PASSWORD` matches in `.env` and Redis configuration
- Check Redis is accessible on `redis:6379` from `borgstack_internal` network
- Ensure `CACHE_ENABLED=true` in docker-compose.yml

#### 4. Admin Login Issues

**Symptoms:** Cannot login with admin credentials

**Check admin user creation in logs:**
```bash
docker compose logs directus | grep -i "admin"
```

**Verify credentials:**
```bash
grep "DIRECTUS_ADMIN" .env
```

**Solution:**
- Admin user created automatically on first startup
- Verify `ADMIN_EMAIL` and `ADMIN_PASSWORD` are set correctly in `.env`
- Check Directus logs for user creation confirmation
- Restart container if admin user wasn't created: `docker compose restart directus`

---

## Future Enhancements

### Story 5.1: SeaweedFS S3 Storage Migration

Directus is currently using local volume storage (`borgstack_directus_uploads`). Story 5.1 will migrate to SeaweedFS S3-compatible storage for distributed file management.

**Migration Plan:**
1. Deploy SeaweedFS (Story 5.1)
2. Update Directus configuration to use S3 storage
3. Migrate existing files from local volume to SeaweedFS
4. Switch `STORAGE_LOCATIONS` to `seaweedfs`

**S3 Configuration Template:**
See `config/directus/s3-storage.env.example` for the complete S3 configuration that will be used after Story 5.1 is complete.

**Benefits of S3 Migration:**
- Distributed storage across multiple nodes
- Better scalability for large media libraries
- Unified storage with FileFlows media processing
- S3-compatible API for programmatic access

---

## Additional Resources

### Official Documentation
- Directus Docs: https://docs.directus.io/
- REST API Reference: https://docs.directus.io/reference/introduction.html
- GraphQL Reference: https://docs.directus.io/reference/query.html

### BorgStack Integration Guides
- Portuguese User Guide: `docs/03-services/directus.md`
- n8n Integration Examples: `config/n8n/workflows/`
- Lowcoder Integration: Connect Directus as datasource in Lowcoder apps

### Support
- GitHub Issues: https://github.com/directus/directus/issues
- Community Discord: https://directus.chat/
- BorgStack Issues: https://github.com/{YOUR_ORG}/borgstack/issues

---

**Last Updated:** 2025-10-04 (Story 4.1)
**Maintained by:** BorgStack Development Team
