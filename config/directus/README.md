# Directus Configuration for FileFlows Integration

This guide covers manual configuration steps for Directus CMS to integrate with FileFlows media processing via n8n.

## Task 2: Configure Directus Flow for File Upload Notification

### Overview
Create a Directus Flow that automatically triggers when media files are uploaded, sending webhook notifications to n8n for processing.

### Steps

#### 1. Access Directus Admin Panel
```
URL: https://directus.${DOMAIN}/admin
Login: DIRECTUS_ADMIN_EMAIL / DIRECTUS_ADMIN_PASSWORD (from .env)
```

#### 2. Navigate to Flows
- Click **Settings** (gear icon) in the sidebar
- Select **Flows** (under "Automate" section)
- Click **"Create Flow"** button

#### 3. Configure Flow Settings
- **Name:** `FileFlows Processing Trigger`
- **Status:** Active (toggle on)
- **Description:** Automatically trigger FileFlows processing when media files are uploaded to Directus

#### 4. Configure Flow Trigger
Click **"Trigger"** section:

- **Type:** Event Hook
- **Action Type:** Action (Non-Blocking)
  - Non-blocking ensures file upload completes regardless of webhook delivery
- **Scope:** `files.upload`
- **Collections:** `directus_files`

#### 5. Add Condition Operation
Click **"+"** to add operation → Select **"Condition"**

**Purpose:** Filter only media files (video, audio, image)

**Condition 1 (Video):**
```json
{
  "$trigger": {
    "payload": {
      "type": {
        "_contains": "video/"
      }
    }
  }
}
```

**Condition 2 (Audio):**
```json
{
  "$trigger": {
    "payload": {
      "type": {
        "_contains": "audio/"
      }
    }
  }
}
```

**Condition 3 (Image):**
```json
{
  "$trigger": {
    "payload": {
      "type": {
        "_contains": "image/"
      }
    }
  }
}
```

**Combine with:** OR (any condition matches)

#### 6. Add Webhook Operation
Click **"+"** on the TRUE branch → Select **"Webhook / Request URL"**

**Method:** POST

**URL:** `https://{{$env.N8N_HOST}}/webhook/directus-upload`
- Replace `{{$env.N8N_HOST}}` with actual value: `https://n8n.${DOMAIN}/webhook/directus-upload`

**Request Body:**
```json
{
  "event": "{{$trigger.event}}",
  "key": "{{$trigger.key}}",
  "collection": "{{$trigger.collection}}",
  "payload": {{$trigger.payload}}
}
```

**Headers (Optional - for webhook security):**
```
X-Webhook-Source: directus
```

**Advanced Options:**
- **Timeout:** 10000 ms (10 seconds)
- **Retry:** 3 attempts
- **Retry Delay:** 5000 ms (5 seconds)

#### 7. Save and Activate Flow
- Click **"Save"** button (top right)
- Ensure toggle is **Active** (green)
- Flow is now live and will trigger on file uploads

### Testing

#### Test 1: Upload Image File
1. Navigate to **Content → Files**
2. Click **"Upload Files"** button
3. Upload a test image (JPG, PNG, WebP)
4. Verify no errors appear

#### Test 2: Check n8n Execution
1. Access n8n: `https://n8n.${DOMAIN}`
2. Go to **"Executions"** tab
3. Look for execution of "Directus → FileFlows Media Processing" workflow
4. Click execution to see details
5. Verify file metadata was received

#### Test 3: Verify File Copy
```bash
# Check if file was copied to FileFlows input
docker compose exec fileflows ls -la /input/
```

Expected: Test file appears in `/input/` directory

---

## Task 4: Configure Directus Custom Fields for Processed Media

### Overview
Add custom fields to `directus_files` collection to track processing status and store processed media URLs.

### Steps

#### 1. Access Data Model
- Click **Settings** (gear icon)
- Select **Data Model** (under "Project" section)
- Find and click **"directus_files"** collection

#### 2. Add Field: `processed_url`
Click **"Create Field"** → **Input**

- **Key:** `processed_url`
- **Type:** String
- **Interface:** Input
- **Field Detail:**
  - **Display Name:** Processed URL
  - **Note:** URL to the processed/optimized media file generated by FileFlows
- **Validation:**
  - **Max Length:** 500
  - **Nullable:** Yes (not all files will be processed)
- **Default Value:** (leave empty)
- Click **"Save"**

#### 3. Add Field: `processing_status`
Click **"Create Field"** → **Dropdown**

- **Key:** `processing_status`
- **Type:** String
- **Interface:** Dropdown (Single)
- **Field Detail:**
  - **Display Name:** Processing Status
  - **Note:** Current status of media processing workflow
- **Choices:**
  ```
  pending - Queued for processing
  processing - Currently being processed by FileFlows
  completed - Successfully processed
  failed - Processing failed (check processing_metadata for error details)
  ```
- **Default Value:** `pending`
- **Allow None:** No
- **Allow Other:** No
- Click **"Save"**

#### 4. Add Field: `processing_metadata`
Click **"Create Field"** → **Code**

- **Key:** `processing_metadata`
- **Type:** JSON
- **Interface:** Input Code
- **Field Detail:**
  - **Display Name:** Processing Metadata
  - **Note:** Processing details, timestamps, error messages, and file statistics
- **Language:** JSON
- **Line Number:** Yes (enable)
- **Default Value:**
  ```json
  {}
  ```
- Click **"Save"**

#### 5. Update File Detail View
**Optional:** Customize file detail view layout to display new fields

- In **directus_files** collection settings, click **"Layout Options"**
- Drag new fields to visible position:
  - Place `processing_status` near top (high visibility)
  - Place `processed_url` below original file URL
  - Place `processing_metadata` in advanced/debug section
- Click **"Save Layout"**

#### 6. Document Field Schema
Field schema is now:

```json
{
  "processed_url": "string | null",
  "processing_status": "pending | processing | completed | failed",
  "processing_metadata": {
    "processing_time": "number (seconds)",
    "original_size": "number (bytes)",
    "processed_size": "number (bytes)",
    "codec": "string",
    "resolution": "string",
    "error_message": "string (if failed)",
    "error_category": "string (if failed)",
    "error_timestamp": "ISO 8601 datetime (if failed)"
  }
}
```

### Testing

#### Test 1: Verify Fields Exist
1. Navigate to **Content → Files**
2. Click any existing file
3. Scroll down to see new fields:
   - ✅ Processing Status (dropdown)
   - ✅ Processed URL (text input)
   - ✅ Processing Metadata (JSON editor)

#### Test 2: Manual Field Update
1. Select a file
2. Set **Processing Status** to "completed"
3. Add **Processed URL:** `https://example.com/test.webp`
4. Add **Processing Metadata:**
   ```json
   {
     "processing_time": 12.5,
     "codec": "webp",
     "resolution": "1920x1080"
   }
   ```
5. Click **"Save"**
6. Refresh page and verify values persist

#### Test 3: API Query
Test Directus API to verify fields are accessible:

```bash
# Get file with processing fields
curl -X GET "https://directus.${DOMAIN}/items/directus_files?fields=id,filename_download,processing_status,processed_url,processing_metadata" \
  -H "Authorization: Bearer ${DIRECTUS_API_TOKEN}"
```

Expected: JSON response includes all processing fields

---

## Troubleshooting

### Flow not triggering
- Verify Flow is **Active** (green toggle)
- Check Directus logs: `docker compose logs directus`
- Test with manual webhook call (see n8n workflows README)

### Webhook fails with timeout
- Verify n8n is running: `docker compose ps n8n`
- Verify webhook URL is correct: `https://n8n.${DOMAIN}/webhook/directus-upload`
- Check n8n workflow is active

### Fields not appearing
- Hard refresh browser (Ctrl+Shift+R)
- Clear Directus cache: Restart Directus container
- Verify user has permission to view custom fields

### Processing status not updating
- Verify n8n workflows are active (check Tasks 1, 3, 7)
- Verify FileFlows webhooks are configured (Task 5)
- Check n8n execution logs for errors

---

## Next Steps

After completing Directus configuration:

1. **Task 5:** Configure FileFlows webhooks for completion notifications
2. **Task 6:** Create FileFlows processing flows (Video H.264, Audio Normalization, Image WebP)
3. **Task 10:** Run integration tests (`./tests/integration/test-directus-fileflows.sh`)

---

## References

- Directus Flows Documentation: https://docs.directus.io/app/flows.html
- Directus Data Model: https://docs.directus.io/app/data-model.html
- Directus API Reference: https://docs.directus.io/reference/api/
