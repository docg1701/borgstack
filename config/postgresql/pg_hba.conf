# ============================================================================
# BorgStack - PostgreSQL Host-Based Authentication Configuration
# ============================================================================
#
# Controls which hosts/users can connect to which databases
#
# Format:
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# TYPE: local (Unix socket) or host (TCP/IP)
# DATABASE: database name or "all"
# USER: username or "all"
# ADDRESS: IP address/mask (for host connections)
# METHOD: authentication method (trust, md5, scram-sha-256)
#
# ============================================================================

# ============================================================================
# Local Connections (Unix Socket)
# ============================================================================
# Allow local socket connections for superuser
local   all             postgres                                trust

# Service users - local socket connections with password
# Using md5 for Unix socket connections (less overhead, still secure within container)
local   n8n_db          n8n_user                                md5
local   chatwoot_db     chatwoot_user                           md5
local   directus_db     directus_user                           md5
local   evolution_db    evolution_user                          md5

# ============================================================================
# Docker Network Connections (TCP/IP)
# ============================================================================
# Allow all Docker network connections with password authentication
# This covers the borgstack_internal network (172.18.0.0/16 by default)

# Superuser - can connect to all databases
host    all             postgres        all                     scram-sha-256

# n8n - can only connect to n8n_db
host    n8n_db          n8n_user        all                     scram-sha-256

# Chatwoot - can only connect to chatwoot_db
host    chatwoot_db     chatwoot_user   all                     scram-sha-256

# Directus - can only connect to directus_db
host    directus_db     directus_user   all                     scram-sha-256

# Evolution API - can only connect to evolution_db
host    evolution_db    evolution_user  all                     scram-sha-256

# ============================================================================
# Deny All Other Connections
# ============================================================================
# Reject any connection not explicitly allowed above
# This ensures database isolation between services

# Deny all other database/user combinations
host    all             all             all                     reject

# ============================================================================
# End of Configuration
# ============================================================================
