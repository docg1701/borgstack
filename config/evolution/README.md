# Evolution API - WhatsApp Instance Setup Guide

## Overview

Evolution API is a self-hosted WhatsApp Business API gateway that enables multi-instance WhatsApp connectivity for BorgStack. This guide explains how to create WhatsApp instances, connect them via QR code, and configure webhooks for n8n integration.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Creating a WhatsApp Instance](#creating-a-whatsapp-instance)
3. [Connecting WhatsApp via QR Code](#connecting-whatsapp-via-qr-code)
4. [Multi-Instance Configuration](#multi-instance-configuration)
5. [Webhook Configuration](#webhook-configuration)
6. [Message Sending/Receiving Test](#message-sendingreceiving-test)
7. [Troubleshooting](#troubleshooting)

---

## Prerequisites

✅ **Before creating WhatsApp instances, ensure:**

1. **BorgStack is deployed and running:**
   ```bash
   docker compose ps
   # Verify 'evolution' container is healthy
   ```

2. **DNS is configured:**
   - evolution.yourdomain.com points to your server IP
   - SSL certificate is provisioned (check first HTTPS access)

3. **Evolution API credentials:**
   - Located in `.env` file (generated by bootstrap.sh)
   - `EVOLUTION_API_KEY`: Required for all API operations
   - `EVOLUTION_HOST`: Your Evolution API domain

4. **WhatsApp phone number:**
   - Valid phone number with active WhatsApp account
   - Phone number NOT currently connected to WhatsApp Web (disconnect if active)
   - Recommendation: Use WhatsApp Business for professional accounts

---

## Creating a WhatsApp Instance

### Option 1: Web UI (Admin Panel)

1. **Access Evolution API Admin UI:**
   ```
   https://evolution.yourdomain.com/manager
   ```

2. **Create New Instance:**
   - Click "Create Instance" button
   - **Instance Name:** Use descriptive name (e.g., `customer_support`, `sales_team`)
   - **Instance Type:** Select "WhatsApp Baileys" (default)
   - **Webhook URL:** `https://n8n.yourdomain.com/webhook/whatsapp-incoming`
   - **Enable Webhook Events:**
     - ✅ MESSAGES_UPSERT (incoming messages)
     - ✅ CONNECTION_UPDATE (connection status changes)
   - Click "Create"

3. **QR Code Display:**
   - QR code will appear automatically after instance creation
   - QR code expires after 30 seconds (refreshes automatically)

### Option 2: API (Programmatic)

```bash
# Replace YOUR_EVOLUTION_API_KEY and evolution.yourdomain.com with your actual values

curl -X POST "https://evolution.yourdomain.com/instance/create" \
  -H "Content-Type: application/json" \
  -H "apikey: YOUR_EVOLUTION_API_KEY" \
  -d '{
    "instanceName": "customer_support",
    "qrcode": true,
    "integration": "WHATSAPP-BAILEYS",
    "webhook": {
      "url": "https://n8n.yourdomain.com/webhook/whatsapp-incoming",
      "byEvents": true,
      "events": [
        "MESSAGES_UPSERT",
        "MESSAGES_UPDATE",
        "CONNECTION_UPDATE"
      ]
    }
  }'
```

**Expected Response (200 OK):**
```json
{
  "instance": {
    "instanceName": "customer_support",
    "instanceId": "af6c5b7c-ee27-4f94-9ea8-192393746ddd",
    "status": "created"
  },
  "hash": {
    "apikey": "auto-generated-instance-key"
  },
  "qrcode": {
    "code": "1@..."
  }
}
```

---

## Connecting WhatsApp via QR Code

### Step-by-Step QR Code Authentication

1. **Get QR Code:**
   - **Web UI:** QR code appears automatically after instance creation
   - **API:** QR code returned in `/instance/create` response or fetch via:
     ```bash
     curl "https://evolution.yourdomain.com/instance/qrcode/customer_support" \
       -H "apikey: YOUR_EVOLUTION_API_KEY"
     ```

2. **Scan QR Code with WhatsApp:**
   - Open WhatsApp on your phone
   - Go to **Settings** → **Linked Devices** (or **WhatsApp Web** on older versions)
   - Tap **Link a Device**
   - Scan the QR code displayed on Evolution API Admin UI or terminal

3. **Connection Confirmation:**
   - WhatsApp will show "Linking Device..." → "Connected"
   - Evolution API logs will show: `[Evolution API] WhatsApp connected: customer_support`
   - Instance status changes to `open` (connected)

4. **Verify Connection:**
   ```bash
   curl "https://evolution.yourdomain.com/instance/connectionState/customer_support" \
     -H "apikey: YOUR_EVOLUTION_API_KEY"
   ```
   **Expected Response:**
   ```json
   {
     "instance": "customer_support",
     "state": "open"
   }
   ```

### Important Notes

⚠️ **QR Code Expiration:**
- QR codes expire after 30 seconds
- Evolution API auto-refreshes QR codes
- If QR code expires before scanning, refresh the admin UI or fetch a new QR code

⚠️ **Phone Number Limitations:**
- One WhatsApp number can only be connected to ONE Evolution API instance at a time
- If you connect the same number to a new instance, the old instance will disconnect
- To reconnect an existing instance after server restart, QR code re-authentication is NOT required (session persists in `borgstack_evolution_instances` volume)

⚠️ **WhatsApp Web Conflicts:**
- Disconnect WhatsApp Web sessions before connecting to Evolution API
- Evolution API uses the same WhatsApp Web protocol

---

## Multi-Instance Configuration

Evolution API supports **multiple WhatsApp instances** (separate business accounts) on the same server.

### Use Cases

- **Multiple Businesses:** Separate instance per business/brand
- **Department Isolation:** Sales, support, marketing teams with dedicated numbers
- **Geographic Separation:** Different instances for different regions/countries

### Creating Multiple Instances

Each instance requires:
- Unique **instanceName** (e.g., `sales_team`, `support_latam`)
- Unique **WhatsApp phone number** (cannot reuse same number across instances)
- Separate **QR code authentication** per instance

**Example: Create 3 instances**

```bash
# Instance 1: Customer Support
curl -X POST "https://evolution.yourdomain.com/instance/create" \
  -H "apikey: YOUR_EVOLUTION_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"instanceName": "customer_support", "qrcode": true, "integration": "WHATSAPP-BAILEYS"}'

# Instance 2: Sales Team
curl -X POST "https://evolution.yourdomain.com/instance/create" \
  -H "apikey: YOUR_EVOLUTION_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"instanceName": "sales_team", "qrcode": true, "integration": "WHATSAPP-BAILEYS"}'

# Instance 3: Marketing
curl -X POST "https://evolution.yourdomain.com/instance/create" \
  -H "apikey: YOUR_EVOLUTION_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"instanceName": "marketing", "qrcode": true, "integration": "WHATSAPP-BAILEYS"}'
```

Each instance:
- Maintains separate WhatsApp session
- Stores data in isolated directory: `/evolution/instances/{instanceName}`
- Requires separate QR code authentication
- Can have different webhook configurations

### Instance Management Commands

**List All Instances:**
```bash
curl "https://evolution.yourdomain.com/instance/fetchInstances" \
  -H "apikey: YOUR_EVOLUTION_API_KEY"
```

**Get Instance Details:**
```bash
curl "https://evolution.yourdomain.com/instance/connectionState/customer_support" \
  -H "apikey: YOUR_EVOLUTION_API_KEY"
```

**Delete Instance:**
```bash
curl -X DELETE "https://evolution.yourdomain.com/instance/delete/customer_support" \
  -H "apikey: YOUR_EVOLUTION_API_KEY"
```

---

## Webhook Configuration

Evolution API sends incoming WhatsApp messages to n8n via webhooks.

### Webhook Architecture

```
WhatsApp Message → Evolution API → Webhook POST → n8n → Chatwoot/Other Services
```

### Default Webhook URL

Configured during bootstrap:
```
EVOLUTION_WEBHOOK_URL=https://n8n.yourdomain.com/webhook/whatsapp-incoming
```

### n8n Webhook Setup

1. **Create n8n Workflow:**
   - Import example workflow: `config/n8n/workflows/03-whatsapp-evolution-incoming.json`
   - Or create new workflow with Webhook trigger node

2. **Configure Webhook Trigger Node:**
   - **HTTP Method:** POST
   - **Path:** `whatsapp-incoming`
   - **Authentication:** None (Evolution API doesn't support webhook authentication)
   - **Respond:** Immediately with 200 OK

3. **Activate Workflow:**
   - Click "Active" toggle in n8n workflow
   - Webhook endpoint becomes available: `https://n8n.yourdomain.com/webhook/whatsapp-incoming`

### Webhook Event Payload

**Incoming Message Event (MESSAGES_UPSERT):**
```json
{
  "event": "messages.upsert",
  "instance": "customer_support",
  "data": {
    "key": {
      "remoteJid": "5511987654321@s.whatsapp.net",
      "fromMe": false,
      "id": "3EB0C8F3E7E3A7D8C0F1"
    },
    "message": {
      "conversation": "Olá, preciso de ajuda com meu pedido #12345"
    },
    "messageTimestamp": 1735632000,
    "pushName": "João Silva"
  }
}
```

**Connection Update Event (CONNECTION_UPDATE):**
```json
{
  "event": "connection.update",
  "instance": "customer_support",
  "data": {
    "state": "open"
  }
}
```

### Testing Webhook Delivery

1. **Send test message to WhatsApp instance:**
   - Send a message from ANY phone number to the WhatsApp number connected to Evolution API

2. **Check n8n execution log:**
   - n8n → Executions tab
   - Verify webhook received message payload

3. **Debug webhook issues:**
   ```bash
   # Check Evolution API logs
   docker compose logs evolution -f

   # Check n8n logs
   docker compose logs n8n -f
   ```

---

## Message Sending/Receiving Test

### Test 1: Send Message from Evolution API

```bash
# Send text message
curl -X POST "https://evolution.yourdomain.com/message/sendText/customer_support" \
  -H "apikey: YOUR_EVOLUTION_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "number": "5511987654321",
    "text": "Olá! Esta é uma mensagem de teste do BorgStack Evolution API.",
    "delay": 1000
  }'
```

**Expected Response:**
```json
{
  "key": {
    "remoteJid": "5511987654321@s.whatsapp.net",
    "fromMe": true,
    "id": "BAE5..."
  },
  "message": {
    "conversation": "Olá! Esta é uma mensagem de teste..."
  },
  "messageTimestamp": 1735632000,
  "status": "PENDING"
}
```

**Verification:**
- Recipient receives message on WhatsApp
- Message appears in WhatsApp chat on connected phone

### Test 2: Receive Message (Webhook Trigger)

1. **Send message TO the WhatsApp instance:**
   - From ANY phone, send message to the WhatsApp number connected to Evolution API
   - Example: "Teste de recebimento de mensagem"

2. **Verify webhook delivery:**
   - n8n workflow executes automatically
   - Check n8n → Executions → Latest execution
   - Verify message payload received

3. **Expected n8n payload:**
   ```json
   {
     "event": "messages.upsert",
     "instance": "customer_support",
     "data": {
       "message": {
         "conversation": "Teste de recebimento de mensagem"
       }
     }
   }
   ```

---

## Troubleshooting

### Issue 1: QR Code Not Displaying

**Symptoms:**
- QR code blank or shows error
- `/instance/create` returns error

**Solutions:**
1. **Check Evolution API container health:**
   ```bash
   docker compose ps evolution
   # Should show: healthy
   ```

2. **Check Evolution API logs:**
   ```bash
   docker compose logs evolution -f
   # Look for Prisma migration errors or database connection issues
   ```

3. **Verify database connection:**
   ```bash
   docker compose logs evolution | grep -i "database\|prisma"
   # Should show: "Prisma migration completed successfully"
   ```

4. **Check EVOLUTION_API_KEY:**
   ```bash
   grep EVOLUTION_API_KEY .env
   # Ensure key is set and matches API requests
   ```

### Issue 2: QR Code Scan Succeeds but Connection Fails

**Symptoms:**
- QR code scans successfully
- WhatsApp shows "Linking Device..." but never completes
- Instance status stuck on `connecting` instead of `open`

**Solutions:**
1. **Check Evolution API logs for errors:**
   ```bash
   docker compose logs evolution --tail 100 | grep -i error
   ```

2. **Verify Redis connection:**
   ```bash
   docker compose logs evolution | grep -i redis
   # Should show: "Redis connected"
   ```

3. **Restart Evolution API container:**
   ```bash
   docker compose restart evolution
   # Wait 60 seconds for health check, then retry QR code
   ```

4. **Disconnect all WhatsApp Web sessions:**
   - WhatsApp → Settings → Linked Devices → Disconnect all
   - Wait 5 minutes, then retry QR code scan

### Issue 3: Webhooks Not Delivered to n8n

**Symptoms:**
- Messages sent to WhatsApp number not triggering n8n workflow
- n8n execution log shows no webhook events

**Solutions:**
1. **Verify n8n webhook is active:**
   ```bash
   curl "https://n8n.yourdomain.com/webhook/whatsapp-incoming" \
     -X POST \
     -H "Content-Type: application/json" \
     -d '{"test": "webhook"}'
   # Should return 200 OK if webhook is active
   ```

2. **Check Evolution API webhook configuration:**
   ```bash
   curl "https://evolution.yourdomain.com/webhook/find/customer_support" \
     -H "apikey: YOUR_EVOLUTION_API_KEY"
   # Verify webhook URL and events are configured
   ```

3. **Update webhook URL if incorrect:**
   ```bash
   curl -X PUT "https://evolution.yourdomain.com/webhook/set/customer_support" \
     -H "apikey: YOUR_EVOLUTION_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "url": "https://n8n.yourdomain.com/webhook/whatsapp-incoming",
       "enabled": true,
       "events": ["MESSAGES_UPSERT", "CONNECTION_UPDATE"]
     }'
   ```

4. **Check network connectivity:**
   ```bash
   # From Evolution API container, test n8n webhook reachability
   docker compose exec evolution wget -qO- "https://n8n.yourdomain.com/webhook/whatsapp-incoming" \
     -d '{"test": true}'
   ```

### Issue 4: Instance Disconnects Randomly

**Symptoms:**
- Instance status changes from `open` to `close` unexpectedly
- Need to re-scan QR code frequently

**Solutions:**
1. **Check WhatsApp phone connectivity:**
   - Ensure WhatsApp phone has stable internet connection
   - WhatsApp app must be active on phone (Evolution API uses WhatsApp Web protocol)

2. **Verify session data persistence:**
   ```bash
   docker volume inspect borgstack_evolution_instances
   # Ensure volume exists and has data

   docker compose exec evolution ls -la /evolution/instances/
   # Should show directory for each instance with auth data
   ```

3. **Check Evolution API restart policy:**
   ```bash
   docker compose config | grep -A 5 "evolution:" | grep restart
   # Should show: unless-stopped
   ```

4. **Monitor Evolution API memory/CPU:**
   ```bash
   docker stats evolution
   # Check if container is resource-constrained
   ```

### Issue 5: Message Sending Fails

**Symptoms:**
- `/message/sendText` returns error
- Messages not delivered to WhatsApp recipient

**Solutions:**
1. **Verify instance is connected:**
   ```bash
   curl "https://evolution.yourdomain.com/instance/connectionState/customer_support" \
     -H "apikey: YOUR_EVOLUTION_API_KEY"
   # State should be: "open"
   ```

2. **Check phone number format:**
   - Must include country code (e.g., `5511987654321` for Brazil)
   - Do NOT include `+` or spaces
   - Format: `{country_code}{area_code}{number}`

3. **Verify recipient WhatsApp account:**
   - Recipient must have active WhatsApp account
   - Test by sending message from personal WhatsApp first

4. **Check Evolution API logs:**
   ```bash
   docker compose logs evolution | grep -i "send\|error"
   ```

---

## Additional Resources

- **Evolution API Official Documentation:** https://doc.evolution-api.com/v2/
- **n8n Webhook Documentation:** https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.webhook/
- **WhatsApp Business API Guide:** https://developers.facebook.com/docs/whatsapp/
- **BorgStack n8n Integration Examples:** `config/n8n/workflows/03-whatsapp-evolution-incoming.json`

---

## Security Best Practices

1. **Protect Evolution API Key:**
   - Never expose `EVOLUTION_API_KEY` in client-side code
   - Rotate API key monthly in production environments
   - Store in password manager

2. **Use HTTPS for Webhooks:**
   - Evolution API requires HTTPS for webhook delivery
   - Let's Encrypt SSL certificates auto-provisioned by Caddy

3. **Monitor Instance Activity:**
   - Review n8n execution logs regularly
   - Set up alerts for webhook delivery failures

4. **Backup WhatsApp Session Data:**
   - Included in Duplicati backup strategy (Story 5.2)
   - Volume: `borgstack_evolution_instances`
   - Loss of session data requires QR code re-authentication

---

## Support

For issues not covered in this guide:
- Check Evolution API logs: `docker compose logs evolution -f`
- Review n8n webhook execution logs
- Consult Evolution API documentation: https://doc.evolution-api.com/v2/
- Open issue in BorgStack repository: https://github.com/YOUR_ORG/borgstack/issues
